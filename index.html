<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mine Tycoon - Sci-Fi Overhaul</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mine-tycoon-sf-default'; // Unique App ID
        
        let app;
        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;
        let gameSaveUnsubscribe = null; 
        let marketUpdateInterval = null;

        // --- Game Object ---
        const Game = {
            state: {}, 
            achievementsList: {}, 
            investableAssets: {},
            prestigeUpgradeDefinitions: {}, 

            // --- Initialization ---
            async init() {
                this.achievementsList = this.getAchievementDefinitions(); 
                this.investableAssets = this.getInvestableAssetsDefinition();
                this.prestigeUpgradeDefinitions = this.getPrestigeUpgradeDefinitions(); 
                this.state = this.getDefaultState(); 
                document.getElementById('loading-message').classList.remove('hidden');
                try {
                    if (Object.keys(firebaseConfig).length > 0) {
                        app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        setLogLevel('debug'); 

                        await setPersistence(auth, browserLocalPersistence); 

                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                                console.log("User is signed in with UID:", userId);
                                const userIdDisplaySettings = document.getElementById('user-id-display-settings');
                                if (userIdDisplaySettings) userIdDisplaySettings.textContent = userId;
                                isAuthReady = true;
                                await this.loadGame(); 
                            } else {
                                console.log("User is not signed in. Attempting sign-in.");
                                const userIdDisplaySettings = document.getElementById('user-id-display-settings');
                                if (userIdDisplaySettings) userIdDisplaySettings.textContent = 'N/A (Not Signed In)';
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                        await signInWithCustomToken(auth, __initial_auth_token);
                                    } else {
                                        await signInAnonymously(auth);
                                    }
                                } catch (error) {
                                    console.error("Error during sign-in:", error);
                                    isAuthReady = true; 
                                    this.resetState(false); 
                                    this.checkDailyLogin(); 
                                    this.render();
                                    document.getElementById('loading-message').classList.add('hidden');
                                }
                            }
                        });
                    } else {
                        console.warn("Firebase config is empty. Game will run in offline mode without saving.");
                        const userIdDisplaySettings = document.getElementById('user-id-display-settings');
                        if (userIdDisplaySettings) userIdDisplaySettings.textContent = 'N/A (Offline Mode)';
                        isAuthReady = true; 
                        this.resetState(false); 
                        this.calculateOfflineProgression(Date.now()); 
                        this.checkDailyLogin();
                        this.render();
                        document.getElementById('loading-message').classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    const userIdDisplaySettings = document.getElementById('user-id-display-settings');
                    if (userIdDisplaySettings) userIdDisplaySettings.textContent = 'N/A (Error)';
                    isAuthReady = true; 
                    this.resetState(false); 
                    this.calculateOfflineProgression(Date.now()); 
                    this.checkDailyLogin();
                    this.render();
                    document.getElementById('loading-message').classList.add('hidden');
                }

                this.setupEventListeners();
                this.startMarketUpdates(); 
                setInterval(() => this.update(), 1000); 
                setInterval(() => this.autoSaveGame(), 30000); 
                setInterval(() => { 
                    if (this.state && this.state.stats) {
                        this.state.stats.totalTimePlayedSeconds += 5;
                    }
                }, 5000);
            },

            getAchievementDefinitions() {
                 return {
                    // Mining Milestones
                    mine_1k_stone: { name: "Stone Digger", description: "Mine 1,000 Stone.", category: "Mining", condition: () => this.state.resources.stone.count >= 1000 },
                    mine_100k_stone: { name: "Stone Miner", description: "Mine 100,000 Stone.", category: "Mining", condition: () => this.state.resources.stone.count >= 100000 },
                    mine_10m_stone: { name: "Stone Tycoon", description: "Mine 10,000,000 Stone.", category: "Mining", condition: () => this.state.resources.stone.count >= 10000000 },
                    mine_10k_coal: { name: "Coal Collector", description: "Mine 10,000 Coal.", category: "Mining", condition: () => this.state.resources.coal.count >= 10000 },
                    mine_1k_iron: { name: "Iron Baron", description: "Mine 1,000 Iron.", category: "Mining", condition: () => this.state.resources.iron.count >= 1000 },
                    mine_5k_copper: { name: "Copper Collector", description: "Mine 5,000 Copper.", category: "Mining", condition: () => this.state.resources.copper.count >= 5000 },
                    mine_1k_quartz: { name: "Quartz Quarryman", description: "Mine 1,000 Quartz.", category: "Mining", condition: () => this.state.resources.quartz?.count >= 1000 },
                    mine_100_gold: { name: "Gold Hoarder", description: "Mine 100 Gold.", category: "Mining", condition: () => this.state.resources.gold.count >= 100 },
                    mine_10_diamond: { name: "Diamond King", description: "Mine 10 Diamond.", category: "Mining", condition: () => this.state.resources.diamond.count >= 10 },
                    mine_10_platinum: { name: "Platinum Prospector", description: "Mine 10 Platinum.", category: "Mining", condition: () => this.state.resources.platinum.count >= 10 },
                    mine_10_emerald: { name: "Emerald Enthusiast", description: "Mine 10 Emeralds.", category: "Mining", condition: () => this.state.resources.emerald.count >= 10 },
                    mine_10_ruby: { name: "Ruby Rover", description: "Mine 10 Rubies.", category: "Mining", condition: () => this.state.resources.ruby.count >= 10 },
                    mine_10_sapphire: { name: "Sapphire Seeker", description: "Mine 10 Sapphires.", category: "Mining", condition: () => this.state.resources.sapphire.count >= 10 },
                    mine_10_amethyst: { name: "Amethyst Hunter", description: "Mine 10 Amethysts.", category: "Mining", condition: () => this.state.resources.amethyst.count >= 10 },
                    mine_obsidian_master: { name: "Obsidian Carver", description: "Mine 1,000 Obsidian.", category: "Mining", condition: () => this.state.resources.obsidian.count >= 1000 },
                    mine_mythril_adept: { name: "Mythril Adept", description: "Mine 500 Mythril.", category: "Mining", condition: () => this.state.resources.mythril?.count >= 500 },
                    mine_orichalcum_lord: { name: "Orichalcum Lord", description: "Mine 100 Orichalcum.", category: "Mining", condition: () => this.state.resources.orichalcum?.count >= 100 },
                    mine_element_x: { name: "X Marks the Spot", description: "Mine your first Element X.", category: "Mining", condition: () => this.state.resources.element_x?.count >= 1 },
                    mine_1k_titanium: { name: "Titanium Titan", description: "Mine 1,000 Titanium.", category: "Mining", condition: () => this.state.resources.titanium?.count >= 1000 },
                    mine_100_uranium: { name: "Nuclear Option", description: "Mine 100 Uranium.", category: "Mining", condition: () => this.state.resources.uranium?.count >= 100 },
                    mine_10_void_crystal: { name: "Void Gazer", description: "Mine 10 Void Crystals.", category: "Mining", condition: () => this.state.resources.void_crystal?.count >= 10 },
                    mine_100_stardust: { name: "Stardust Collector", description: "Collect 100 Stardust.", category: "Mining", condition: () => this.state.resources.stardust?.count >= 100 },
                    mine_50_nebula_gas: { name: "Nebula Navigator", description: "Extract 50 Nebula Gas.", category: "Mining", condition: () => this.state.resources.nebula_gas?.count >= 50 },


                    // Wealth Milestones
                    wealth_1k: { name: "Pocket Change", description: "Earn $1,000 total.", category: "Wealth", condition: () => this.state.money >= 1000 },
                    wealth_100k: { name: "Well Off", description: "Earn $100,000 total.", category: "Wealth", condition: () => this.state.money >= 100000 },
                    wealth_1m: { name: "Millionaire", description: "Earn $1,000,000 total.", category: "Wealth", condition: () => this.state.money >= 1000000 },
                    wealth_1b: { name: "Billionaire", description: "Earn $1,000,000,000 total.", category: "Wealth", condition: () => this.state.money >= 1000000000 },
                    wealth_1t: { name: "Trillionaire", description: "Earn $1,000,000,000,000 total.", category: "Wealth", condition: () => this.state.money >= 1000000000000 },
                    wealth_1qa: { name: "Quadrillionaire Club", description: "Earn $1Qa total.", category: "Wealth", condition: () => this.state.money >= 1e15 },
                    wealth_1qi: { name: "Quintillionaire Status", description: "Earn $1Qi total.", category: "Wealth", condition: () => this.state.money >= 1e18 },


                    // Progression Milestones
                    unlock_coal: { name: "Getting Started", description: "Unlock Coal.", category: "Progression", condition: () => this.state.resources.coal.unlocked },
                    unlock_iron: { name: "Industrialist", description: "Unlock Iron.", category: "Progression", condition: () => this.state.resources.iron.unlocked },
                    unlock_copper: { name: "Copper Age", description: "Unlock Copper.", category: "Progression", condition: () => this.state.resources.copper.unlocked },
                    unlock_quartz: { name: "Crystal Clear", description: "Unlock Quartz.", category: "Progression", condition: () => this.state.resources.quartz?.unlocked },
                    unlock_gold: { name: "Prospector", description: "Unlock Gold.", category: "Progression", condition: () => this.state.resources.gold.unlocked },
                    unlock_diamond: { name: "Gemologist", description: "Unlock Diamond.", category: "Progression", condition: () => this.state.resources.diamond.unlocked },
                    unlock_platinum: { name: "Platinum Club", description: "Unlock Platinum.", category: "Progression", condition: () => this.state.resources.platinum.unlocked },
                    unlock_emerald: { name: "Emerald Expert", description: "Unlock Emeralds.", category: "Progression", condition: () => this.state.resources.emerald.unlocked },
                    unlock_ruby: { name: "Ruby Royalty", description: "Unlock Rubies.", category: "Progression", condition: () => this.state.resources.ruby.unlocked },
                    unlock_sapphire: { name: "Sapphire Sovereign", description: "Unlock Sapphires.", category: "Progression", condition: () => this.state.resources.sapphire.unlocked },
                    unlock_amethyst: { name: "Amethyst Aristocrat", description: "Unlock Amethysts.", category: "Progression", condition: () => this.state.resources.amethyst.unlocked },
                    unlock_obsidian: { name: "Master of Mines", description: "Unlock Obsidian.", category: "Progression", condition: () => this.state.resources.obsidian.unlocked },
                    unlock_mythril: { name: "Mythical Miner", description: "Unlock Mythril.", category: "Progression", condition: () => this.state.resources.mythril?.unlocked },
                    unlock_orichalcum: { name: "Legendary Extractor", description: "Unlock Orichalcum.", category: "Progression", condition: () => this.state.resources.orichalcum?.unlocked },
                    unlock_element_x: { name: "Forbidden Knowledge", description: "Unlock Element X.", category: "Progression", condition: () => this.state.resources.element_x?.unlocked },
                    unlock_titanium: { name: "Titanium Age", description: "Unlock Titanium.", category: "Progression", condition: () => this.state.resources.titanium?.unlocked },
                    unlock_uranium: { name: "Atomic Power", description: "Unlock Uranium.", category: "Progression", condition: () => this.state.resources.uranium?.unlocked },
                    unlock_void_crystal: { name: "Gazing Into The Void", description: "Unlock Void Crystals.", category: "Progression", condition: () => this.state.resources.void_crystal?.unlocked },
                    unlock_stardust: { name: "Cosmic Dusting", description: "Unlock Stardust Collection.", category: "Progression", condition: () => this.state.resources.stardust?.unlocked },
                    unlock_nebula_gas: { name: "Nebulae Whisperer", description: "Unlock Nebula Gas Extraction.", category: "Progression", condition: () => this.state.resources.nebula_gas?.unlocked },
                    first_prestige: { name: "New Beginning", description: "Perform your first Prestige.", category: "Progression", condition: () => this.state.prestige?.prestigesDone >= 1 },
                    
                    // Upgrade Milestones
                    first_upgrade_any: { name: "Tinkerer", description: "Buy any upgrade for any resource.", category: "Upgrades", condition: () => Object.values(this.state.resources).some(r => r.manualMineLevel > 0 || r.miners > 0 || r.minerSpeedLevel > 0) },
                    global_power_5: { name: "Global Power", description: "Reach Level 5 in any Global Upgrade.", category: "Upgrades", condition: () => Object.values(this.state.globalUpgrades).some(upg => upg.level >= 5) },
                    hundred_miners_stone: { name: "Stone Automation", description: "Own 100 Stone Miners.", category: "Upgrades", condition: () => this.state.resources.stone.miners >= 100 },
                    all_global_lvl_1: { name: "Well Rounded", description: "Upgrade all Global Upgrades to at least Level 1.", category: "Upgrades", condition: () => Object.values(this.state.globalUpgrades).every(upg => upg.level >= 1)},
                    
                    // Investment Achievements
                    first_investment: { name: "Market Dabbler", description: "Make your first investment.", category: "Investments", condition: () => Object.values(this.state.investments.portfolio).some(asset => asset.shares > 0) },
                    investment_profit_1k: { name: "Smart Investor", description: "Make $1,000 profit from investments.", category: "Investments", condition: () => (this.state.investments.totalSoldValue - this.state.investments.totalBoughtValue) >= 1000 },

                    // Processing Achievements
                    process_first_ingot: { name: "First Ingot", description: "Process your first Iron Ingot.", category: "Processing", condition: () => this.state.resources.iron_ingot?.count >= 1 && this.state.resources.iron_ingot?.unlocked, outputResourceId: 'iron_ingot' },
                    process_100_ingots: { name: "Skilled Smelter", description: "Process 100 Iron Ingots.", category: "Processing", condition: () => this.state.resources.iron_ingot?.count >= 100, outputResourceId: 'iron_ingot' },
                    process_first_copper_ingot: { name: "Copper Chaser", description: "Process your first Copper Ingot.", category: "Processing", condition: () => this.state.resources.copper_ingot?.count >= 1 && this.state.resources.copper_ingot?.unlocked, outputResourceId: 'copper_ingot' },
                    process_first_gold_bar: { name: "Gold Standard", description: "Process your first Gold Bar.", category: "Processing", condition: () => this.state.resources.gold_bar?.count >= 1 && this.state.resources.gold_bar?.unlocked, outputResourceId: 'gold_bar' },
                    process_first_silicon: { name: "Silicon Valley Start", description: "Process your first Silicon Wafer.", category: "Processing", condition: () => this.state.resources.silicon?.count >= 1 && this.state.resources.silicon?.unlocked, outputResourceId: 'silicon' },
                    process_first_steel: { name: "Steel Foundation", description: "Process your first Steel Plate.", category: "Processing", condition: () => this.state.resources.steel_plate?.count >= 1 && this.state.resources.steel_plate?.unlocked, outputResourceId: 'steel_plate' },
                    process_first_circuit: { name: "Circuit Board Genius", description: "Process your first Advanced Circuit.", category: "Processing", condition: () => this.state.resources.advanced_circuit?.count >= 1 && this.state.resources.advanced_circuit?.unlocked, outputResourceId: 'advanced_circuit' },
                    process_refined_x: { name: "Exotic Refinement", description: "Process your first Refined Element X.", category: "Processing", condition: () => this.state.resources.refined_element_x?.count >= 1 && this.state.resources.refined_element_x?.unlocked, outputResourceId: 'refined_element_x' },
                    process_quantum_entangler: { name: "Quantum Leap", description: "Create a Quantum Entangler.", category: "Processing", condition: () => this.state.resources.quantum_entangler?.count >= 1 && this.state.resources.quantum_entangler?.unlocked, outputResourceId: 'quantum_entangler' },
                    process_singularity_core: { name: "Heart of the Singularity", description: "Forge a Singularity Core.", category: "Processing", condition: () => this.state.resources.singularity_core?.count >= 1 && this.state.resources.singularity_core?.unlocked, outputResourceId: 'singularity_core' },
                    process_titanium_alloy: { name: "Alloy Artisan", description: "Forge your first Titanium Alloy.", category: "Processing", condition: () => this.state.resources.titanium_alloy?.count >= 1 && this.state.resources.titanium_alloy?.unlocked, outputResourceId: 'titanium_alloy' },
                    process_enriched_uranium: { name: "Nuclear Physicist", description: "Enrich your first Uranium.", category: "Processing", condition: () => this.state.resources.enriched_uranium?.count >= 1 && this.state.resources.enriched_uranium?.unlocked, outputResourceId: 'enriched_uranium' },
                    process_power_cell: { name: "Power Overwhelming", description: "Fabricate a Power Cell.", category: "Processing", condition: () => this.state.resources.power_cell?.count >= 1 && this.state.resources.power_cell?.unlocked, outputResourceId: 'power_cell' },
                    process_quantum_computer: { name: "Digital Deity", description: "Construct a Quantum Computer.", category: "Processing", condition: () => this.state.resources.quantum_computer?.count >= 1 && this.state.resources.quantum_computer?.unlocked, outputResourceId: 'quantum_computer' },
                    process_void_manipulator: { name: "Void Whisperer", description: "Assemble a Void Manipulator.", category: "Processing", condition: () => this.state.resources.void_manipulator?.count >= 1 && this.state.resources.void_manipulator?.unlocked, outputResourceId: 'void_manipulator' },
                    process_cosmic_alloy: { name: "Cosmic Blacksmith", description: "Forge your first Cosmic Alloy.", category: "Processing", condition: () => this.state.resources.cosmic_alloy?.count >= 1 && this.state.resources.cosmic_alloy?.unlocked, outputResourceId: 'cosmic_alloy' },
                    process_quantum_foam: { name: "Foam Fabricator", description: "Create Quantum Foam.", category: "Processing", condition: () => this.state.resources.quantum_foam?.count >= 1 && this.state.resources.quantum_foam?.unlocked, outputResourceId: 'quantum_foam' },
                    process_galactic_core: { name: "Galactic Engineer", description: "Synthesize a Galactic Core.", category: "Processing", condition: () => this.state.resources.galactic_core?.count >= 1 && this.state.resources.galactic_core?.unlocked, outputResourceId: 'galactic_core' },
                    
                    first_polish: { name: "First Polish", description: "Polish your first gem.", category: "Processing", condition: () => Object.keys(this.state.processors).some(procId => procId.includes('_polisher') && this.state.resources[this.state.processors[procId].outputResourceId]?.count >= 1) },
                    polish_10_diamond: { name: "Diamond Cutter", description: "Produce 10 Polished Diamonds.", category: "Processing", condition: () => this.state.resources.polished_diamond?.count >= 10, outputResourceId: 'polished_diamond' },
                    polish_10_platinum: { name: "Platinum Shine", description: "Produce 10 Polished Platinum.", category: "Processing", condition: () => this.state.resources.polished_platinum?.count >= 10, outputResourceId: 'polished_platinum' },
                    polish_10_emerald: { name: "Emerald Gleam", description: "Produce 10 Polished Emeralds.", category: "Processing", condition: () => this.state.resources.polished_emerald?.count >= 10, outputResourceId: 'polished_emerald' },
                    polish_10_ruby: { name: "Ruby Radiance", description: "Produce 10 Polished Rubies.", category: "Processing", condition: () => this.state.resources.polished_ruby?.count >= 10, outputResourceId: 'polished_ruby' },
                    polish_10_sapphire: { name: "Sapphire Sparkle", description: "Produce 10 Polished Sapphires.", category: "Processing", condition: () => this.state.resources.polished_sapphire?.count >= 10, outputResourceId: 'polished_sapphire' },
                    polish_10_amethyst: { name: "Amethyst Aura", description: "Produce 10 Polished Amethysts.", category: "Processing", condition: () => this.state.resources.polished_amethyst?.count >= 10, outputResourceId: 'polished_amethyst' },
                    
                    unlock_all_processors: { name: "Industrial Revolution", description: "Unlock all standard processors.", category: "Processing", condition: () => Object.values(this.state.processors || {}).filter(p => !p.id.includes('_polisher') && !p.id.includes('_x_') && !p.id.includes('quantum_') && !p.id.includes('singularity_') && !p.id.includes('alloy_') && !p.id.includes('centrifuge_') && !p.id.includes('energy_') && !p.id.includes('void_') && !p.id.includes('stardust_') && !p.id.includes('nebula_') && !p.id.includes('cosmic_') && !p.id.includes('galactic_')).every(p => p.unlocked) },
                    unlock_all_exotic_processors: { name: "Master of Exotics", description: "Unlock all Exotic Material processors (Element X path).", category: "Processing", condition: () => Object.values(this.state.processors || {}).filter(p => p.id.includes('_x_') || p.id.includes('quantum_') || p.id.includes('singularity_') || p.id.includes('alloy_') || p.id.includes('centrifuge_') || p.id.includes('energy_') || p.id.includes('void_')).every(p => p.unlocked) },
                    unlock_all_cosmic_processors: { name: "Cosmic Architect", description: "Unlock all Cosmic processors.", category: "Processing", condition: () => Object.values(this.state.processors || {}).filter(p => p.id.includes('stardust_') || p.id.includes('nebula_') || p.id.includes('cosmic_') || p.id.includes('quantum_foam_') || p.id.includes('galactic_')).every(p => p.unlocked) },
                    master_jeweler: { name: "Master Jeweler", description: "Unlock all gem polishers.", category: "Processing", condition: () => Object.values(this.state.processors || {}).filter(p => p.id.includes('_polisher')).every(p => p.unlocked) },
                    master_processor: { name: "Master Processor", description: "Upgrade any non-gem/exotic processor to Level 5 in either Speed or Efficiency.", category: "Processing", condition: () => Object.values(this.state.processors || {}).filter(p => !p.id.includes('_polisher') && !p.id.includes('_x_') && !p.id.includes('quantum_') && !p.id.includes('singularity_')).some(p => p.speedLevel >= 5 || p.efficiencyLevel >= 5) },
                    gem_polishing_expert: { name: "Gem Polishing Expert", description: "Upgrade any gem polisher to Level 5 in either Speed or Efficiency.", category: "Processing", condition: () => Object.values(this.state.processors || {}).filter(p => p.id.includes('_polisher')).some(p => p.speedLevel >= 5 || p.efficiencyLevel >= 5) },

                    // Market Achievements
                    market_tycoon: { name: "Market Tycoon", description: "Sell $1,000,000 worth of goods via the individual market.", category: "Market", condition: () => this.state.stats.totalSoldViaMarketValue >= 1000000 },
                    strategic_seller: { name: "Strategic Seller", description: "Make 100 individual sales on the market.", category: "Market", condition: () => this.state.stats.individualMarketSalesCount >= 100 },
                    
                    // Research Achievements
                    first_research: { name: "Budding Scientist", description: "Complete your first research project.", category: "Research", condition: () => Object.values(this.state.research || {}).some(r => r.unlocked) },
                    all_standard_research_complete: { name: "Knowledge Seeker", description: "Complete all standard research projects (pre-Element X).", category: "Research", condition: () => Object.values(this.state.research || {}).filter(r => !r.id.includes('element_x') && !r.id.includes('quantum') && !r.id.includes('singularity') && !r.id.includes('nuclear') && !r.id.includes('void') && !r.id.includes('stardust') && !r.id.includes('nebula') && !r.id.includes('cosmic') && !r.id.includes('galactic')).every(r => r.unlocked) },
                    all_exotic_research_complete: { name: "Master of the Unknown", description: "Complete all exotic material research projects.", category: "Research", condition: () => Object.values(this.state.research || {}).filter(r => r.id.includes('element_x') || r.id.includes('quantum') || r.id.includes('singularity') || r.id.includes('nuclear') || r.id.includes('void')).every(r => r.unlocked) },
                    all_cosmic_research_complete: { name: "Galactic Scholar", description: "Complete all cosmic research projects.", category: "Research", condition: () => Object.values(this.state.research || {}).filter(r => r.id.includes('stardust') || r.id.includes('nebula') || r.id.includes('cosmic') || r.id.includes('galactic')).every(r => r.unlocked) },
                    grand_research_master: { name: "Grand Research Master", description: "Complete ALL research projects.", category: "Research", condition: () => Object.values(this.state.research || {}).every(r => r.unlocked) },
                };
            },

            getInvestableAssetsDefinition() {
                return {
                    gold_futures: { name: "Gold Futures", basePrice: 70, volatility: 0.15, trend: 0.005 }, 
                    diamond_futures: { name: "Diamond Futures", basePrice: 240, volatility: 0.25, trend: 0.002 },
                    obsidian_futures: { name: "Obsidian Futures", basePrice: 700, volatility: 0.35, trend: -0.001 },
                    titanium_index: { name: "Titanium Index Fund", basePrice: 1500, volatility: 0.20, trend: 0.003},
                    energy_sector_etf: { name: "Energy Sector ETF", basePrice: 3000, volatility: 0.30, trend: 0.001},
                    exotic_materials_fund: { name: "Exotic Materials Fund", basePrice: 10000, volatility: 0.40, trend: 0.0005 }
                };
            },

            getPrestigeUpgradeDefinitions() {
                return {
                    heavenlyBonus: { level: 0, costBase: 1, costMultiplier: 1.5, effectPerLevel: 0.1, name: "Heavenly Bonus", description: "Increases all income permanently by 10% per level." },
                    timeWarp: { level: 0, costBase: 2, costMultiplier: 1.6, effectPerLevel: 0.05, name: "Time Warp", description: "Increases all miner and processor speeds permanently by 5% per level." },
                    researchGrant: { level: 0, costBase: 3, costMultiplier: 1.7, effectPerLevel: 0.03, name: "Research Grant", description: "Reduces all research times permanently by 3% per level (max 60%)." },
                    startingMiners: { level: 0, costBase: 1, costMultiplier: 2, effectPerLevel: 5, name: "Starting Crew", description: "Start each prestige with 5 extra Stone miners per level." },
                    acceleratedLearning: { level: 0, costBase: 5, costMultiplier: 1.8, effectPerLevel: 0.01, name: "Accelerated Learning", description: "All research projects complete 1% faster per level (max 30%)."}
                };
            },

            // --- Game State Management ---
            getDefaultState() {
                const baseState = { 
                    money: 0,
                    resources: { 
                        // Base Resources
                        stone: { id: 'stone', name: 'Stone', count: 0, value: 1, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 10, miners: 0, minerCostBase: 25, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 20, unlocked: true, unlockRequirements: null, tier: 1 },
                        coal: { id: 'coal', name: 'Coal', count: 0, value: 3, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 50, miners: 0, minerCostBase: 150, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 100, unlocked: false, unlockRequirements: { money: 100 }, tier: 1 },
                        iron: { id: 'iron', name: 'Iron Ore', count: 0, value: 10, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 200, miners: 0, minerCostBase: 750, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 500, unlocked: false, unlockRequirements: { money: 1000, resources: { coal: 50 } }, tier: 1 },
                        copper: { id: 'copper', name: 'Copper Ore', count: 0, value: 25, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 500, miners: 0, minerCostBase: 2000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 1200, unlocked: false, unlockRequirements: { money: 5000, resources: { iron: 20 } }, tier: 1 },
                        quartz: { id: 'quartz', name: 'Raw Quartz', count: 0, value: 15, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 300, miners: 0, minerCostBase: 1000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 800, unlocked: false, unlockRequirements: { money: 2500, resources: { stone: 500 }}, tier: 1},
                        
                        // Gem Resources
                        gold: { id: 'gold', name: 'Gold Ore', count: 0, value: 75, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 1500, miners: 0, minerCostBase: 8000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 4000, unlocked: false, unlockRequirements: { money: 25000, resources: { copper: 100 } }, tier: 2 },
                        diamond: { id: 'diamond', name: 'Rough Diamond', count: 0, value: 250, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 10000, miners: 0, minerCostBase: 50000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 20000, unlocked: false, unlockRequirements: { money: 100000, resources: { gold: 50 } }, tier: 2 },
                        platinum: { id: 'platinum', name: 'Raw Platinum', count: 0, value: 750, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 50000, miners: 0, minerCostBase: 250000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 100000, unlocked: false, unlockRequirements: { money: 500000, resources: { diamond: 100 } }, tier: 2 },
                        emerald: { id: 'emerald', name: 'Rough Emerald', count: 0, value: 2000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 200000, miners: 0, minerCostBase: 1000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 400000, unlocked: false, unlockRequirements: { money: 2500000, resources: { platinum: 75 } }, tier: 2 },
                        ruby: { id: 'ruby', name: 'Rough Ruby', count: 0, value: 5000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 800000, miners: 0, minerCostBase: 4000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 1500000, unlocked: false, unlockRequirements: { money: 10000000, resources: { emerald: 50 } }, tier: 2 },
                        sapphire: { id: 'sapphire', name: 'Rough Sapphire', count: 0, value: 12000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 3000000, miners: 0, minerCostBase: 15000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 6000000, unlocked: false, unlockRequirements: { money: 50000000, resources: { ruby: 40 } }, tier: 2 },
                        amethyst: { id: 'amethyst', name: 'Rough Amethyst', count: 0, value: 30000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 10000000, miners: 0, minerCostBase: 50000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 20000000, unlocked: false, unlockRequirements: { money: 200000000, resources: { sapphire: 30 } }, tier: 2 },
                        
                        // Advanced Resources
                        obsidian: { id: 'obsidian', name: 'Obsidian Chunk', count: 0, value: 75000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 50000000, miners: 0, minerCostBase: 200000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 80000000, unlocked: false, unlockRequirements: { money: 1000000000, resources: { amethyst: 20 } }, tier: 3 },
                        mythril: { id: 'mythril', name: 'Mythril Ore', count: 0, value: 200000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 250000000, miners: 0, minerCostBase: 1000000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 400000000, unlocked: false, unlockRequirements: { money: 5000000000, resources: { obsidian: 100 } }, tier: 3 },
                        orichalcum: { id: 'orichalcum', name: 'Orichalcum Ore', count: 0, value: 1000000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 1000000000, miners: 0, minerCostBase: 5000000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 2000000000, unlocked: false, unlockRequirements: { money: 25000000000, resources: { mythril: 50 } }, tier: 3 },
                        titanium: { id: 'titanium', name: 'Titanium Ore', count: 0, value: 250000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 1.5e11, miners: 0, minerCostBase: 7.5e11, minerProductionBase: 0.15, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 5e11, unlocked: false, unlockRequirements: { money: 1e12, resources: { obsidian: 500 } }, tier: 3 },
                        
                        // Exotic Resources (Unlocked via Research)
                        element_x: { id: 'element_x', name: 'Raw Element X', count: 0, value: 5000000, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 50000000000, miners: 0, minerCostBase: 200000000000, minerProductionBase: 0.2, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 100000000000, unlocked: false, unlockRequirements: null, tier: 4 }, 
                        uranium: { id: 'uranium', name: 'Uranium Ore', count: 0, value: 1.2e7, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 5e13, miners: 0, minerCostBase: 2e14, minerProductionBase: 0.1, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 1e14, unlocked: false, unlockRequirements: null, tier: 4 }, 
                        void_crystal: { id: 'void_crystal', name: 'Raw Void Crystal', count: 0, value: 1e9, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 1e17, miners: 0, minerCostBase: 5e17, minerProductionBase: 0.05, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 2.5e17, unlocked: false, unlockRequirements: null, tier: 4 }, 
                        
                        // Cosmic Resources (Unlocked via Research)
                        stardust: { id: 'stardust', name: 'Stardust Cluster', count: 0, value: 5e10, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 1e20, miners: 0, minerCostBase: 5e20, minerProductionBase: 0.02, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 2.5e20, unlocked: false, unlockRequirements: null, tier: 5 },
                        nebula_gas: { id: 'nebula_gas', name: 'Nebula Gas Pocket', count: 0, value: 2.5e11, manualMineBaseAmount: 1, manualMineLevel: 0, manualMineUpgradeCostBase: 1e22, miners: 0, minerCostBase: 5e22, minerProductionBase: 0.01, minerSpeedLevel: 0, minerSpeedUpgradeCostBase: 2.5e22, unlocked: false, unlockRequirements: null, tier: 5 },

                        // Processed Resources
                        iron_ingot: { id: 'iron_ingot', name: 'Iron Ingot', count: 0, value: 150, unlocked: false, tier: 1 }, 
                        copper_ingot: { id: 'copper_ingot', name: 'Copper Ingot', count: 0, value: 300, unlocked: false, tier: 1 },
                        gold_bar: { id: 'gold_bar', name: 'Gold Bar', count: 0, value: 600, unlocked: false, tier: 2 },
                        silicon: { id: 'silicon', name: 'Silicon Wafer', count: 0, value: 250, unlocked: false, tier: 1},
                        steel_plate: { id: 'steel_plate', name: 'Steel Plate', count: 0, value: 1300, unlocked: false, tier: 1},
                        advanced_circuit: { id: 'advanced_circuit', name: 'Adv. Circuit', count: 0, value: 6000, unlocked: false, tier: 2},
                        polished_diamond: { id: 'polished_diamond', name: 'Polished Diamond', count: 0, value: 750, unlocked: false, tier: 2 }, 
                        polished_platinum: { id: 'polished_platinum', name: 'Polished Platinum', count: 0, value: 2200, unlocked: false, tier: 2 }, 
                        polished_emerald: { id: 'polished_emerald', name: 'Polished Emerald', count: 0, value: 5800, unlocked: false, tier: 2 }, 
                        polished_ruby: { id: 'polished_ruby', name: 'Polished Ruby', count: 0, value: 14500, unlocked: false, tier: 2 }, 
                        polished_sapphire: { id: 'polished_sapphire', name: 'Polished Sapphire', count: 0, value: 34000, unlocked: false, tier: 2 }, 
                        polished_amethyst: { id: 'polished_amethyst', name: 'Polished Amethyst', count: 0, value: 85000, unlocked: false, tier: 2 }, 
                        titanium_alloy: { id: 'titanium_alloy', name: 'Titanium Alloy', count: 0, value: 1.5e6, unlocked: false, tier: 3 },
                        
                        // Processed Exotic Resources
                        refined_element_x: { id: 'refined_element_x', name: 'Refined Element X', count: 0, value: 2.5e7, unlocked: false, tier: 4 }, 
                        quantum_entangler: { id: 'quantum_entangler', name: 'Quantum Entangler', count: 0, value: 1.5e8, unlocked: false, tier: 4 }, 
                        singularity_core: { id: 'singularity_core', name: 'Singularity Core', count: 0, value: 1e9, unlocked: false, tier: 4 }, 
                        enriched_uranium: { id: 'enriched_uranium', name: 'Enriched Uranium', count: 0, value: 7.5e7, unlocked: false, tier: 4 },
                        power_cell: { id: 'power_cell', name: 'Power Cell', count: 0, value: 5e8, unlocked: false, tier: 4 },
                        quantum_computer: { id: 'quantum_computer', name: 'Quantum Computer', count: 0, value: 3e10, unlocked: false, tier: 4 },
                        void_manipulator: { id: 'void_manipulator', name: 'Void Manipulator', count: 0, value: 2e12, unlocked: false, tier: 4 },

                        // Processed Cosmic Resources
                        cosmic_alloy: { id: 'cosmic_alloy', name: 'Cosmic Alloy', count: 0, value: 1e13, unlocked: false, tier: 5 },
                        quantum_foam: { id: 'quantum_foam', name: 'Quantum Foam', count: 0, value: 5e13, unlocked: false, tier: 5 },
                        galactic_core: { id: 'galactic_core', name: 'Galactic Core', count: 0, value: 1e15, unlocked: false, tier: 5 },
                    },
                    globalUpgrades: {
                        sellMultiplier: { level: 0, costBase: 1000, value: 1, increasePerLevel: 0.05, name: "Global Sell Multiplier", description: "Increases the sell price of all resources."},
                        minerSpeedBoost: { level: 0, costBase: 2500, value: 1, increasePerLevel: 0.03, name: "Global Miner Speed Boost", description: "Boosts the speed of all automated miners."},
                        manualMiningBoost: { level: 0, costBase: 500, value: 1, increasePerLevel: 0.1, name: "Global Manual Mining Boost", description: "Increases resources gained per manual click for all types."},
                        researchAndDevelopment: { level: 0, costBase: 10000, value: 1, increasePerLevel: 0.02, name: "Research & Development", description: "Reduces the cost to unlock new resources (2% per level, max 50%)."}, 
                        efficiencyTraining: { level: 0, costBase: 7500, value: 1, increasePerLevel: 0.015, name: "Efficiency Training", description: "Reduces the cost of all resource-specific upgrades (1.5% per level, max 40%)."}, 
                        masterGeologist: { level: 0, costBase: 12000, value: 1, increasePerLevel: 0.05, name: "Master Geologist", description: "Further increases resources gained from manual clicks (stacks with other boosts)."},
                        logisticsOptimization: { level: 0, costBase: 20000, value: 1, increasePerLevel: 0.01, name: "Logistics Optimization", description: "Reduces the cost of hiring new miners (1% per level, max 30%)."}
                    },
                    achievements: {}, 
                    investments: { 
                        market: {}, 
                        portfolio: {}, 
                        totalBoughtValue: 0, 
                        totalSoldValue: 0,   
                        transactionFee: 0.005 
                    },
                    processors: {
                        // Tier 1 Processors
                        iron_smelter: { id: 'iron_smelter', name: 'Iron Smelter', inputs: [{id: 'iron', amountBase: 10}], outputResourceId: 'iron_ingot', outputAmountBase: 1, processingTimeBase: 10, costToProcessBase: 5, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 500, efficiencyUpgradeCostBase: 750, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { iron: 100 }, money: 200 }, tier: 1 },
                        copper_smelter: { id: 'copper_smelter', name: 'Copper Smelter', inputs: [{id: 'copper', amountBase: 8}], outputResourceId: 'copper_ingot', outputAmountBase: 1, processingTimeBase: 15, costToProcessBase: 15, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1200, efficiencyUpgradeCostBase: 1800, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { copper: 100, coal: 50 }, money: 1000 }, tier: 1 },
                        quartz_purifier: { id: 'quartz_purifier', name: 'Quartz Purifier', inputs: [{id: 'quartz', amountBase: 10}], outputResourceId: 'silicon', outputAmountBase: 1, processingTimeBase: 12, costToProcessBase: 20, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1500, efficiencyUpgradeCostBase: 2200, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { quartz: 100, coal: 200 }, money: 3000 }, tier: 1 },
                        steel_mill: { id: 'steel_mill', name: 'Steel Mill', inputs: [{id: 'iron_ingot', amountBase: 5}, {id: 'coal', amountBase: 10}], outputResourceId: 'steel_plate', outputAmountBase: 1, processingTimeBase: 30, costToProcessBase: 100, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 8000, efficiencyUpgradeCostBase: 10000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { iron_ingot: 50, coal: 500 }, money: 15000 }, tier: 1 },
                        
                        // Tier 2 Processors
                        gold_refinery: { id: 'gold_refinery', name: 'Gold Refinery', inputs: [{id: 'gold', amountBase: 5}], outputResourceId: 'gold_bar', outputAmountBase: 1, processingTimeBase: 25, costToProcessBase: 50, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 4000, efficiencyUpgradeCostBase: 6000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { gold: 50, iron_ingot: 10 }, money: 5000 }, tier: 2 },
                        electronics_assembler: { id: 'electronics_assembler', name: 'Electronics Assembler', inputs: [{id: 'gold_bar', amountBase: 2}, {id: 'copper_ingot', amountBase: 5}, {id: 'silicon', amountBase: 3}], outputResourceId: 'advanced_circuit', outputAmountBase: 1, processingTimeBase: 60, costToProcessBase: 500, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 25000, efficiencyUpgradeCostBase: 35000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { gold_bar: 20, copper_ingot: 50, silicon: 30 }, money: 100000 }, tier: 2 },
                        diamond_polisher: { id: 'diamond_polisher', name: 'Diamond Polisher', inputs: [{id: 'diamond', amountBase: 1}], outputResourceId: 'polished_diamond', outputAmountBase: 1, processingTimeBase: 45, costToProcessBase: 125, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 100000, efficiencyUpgradeCostBase: 150000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { diamond: 20, steel_plate: 10 }, money: 200000 }, tier: 2 },
                        platinum_polisher: { id: 'platinum_polisher', name: 'Platinum Polisher', inputs: [{id: 'platinum', amountBase: 1}], outputResourceId: 'polished_platinum', outputAmountBase: 1, processingTimeBase: 50, costToProcessBase: 375, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 250000, efficiencyUpgradeCostBase: 350000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { platinum: 20, advanced_circuit: 5 }, money: 500000 }, tier: 2 },
                        emerald_polisher: { id: 'emerald_polisher', name: 'Emerald Polisher', inputs: [{id: 'emerald', amountBase: 1}], outputResourceId: 'polished_emerald', outputAmountBase: 1, processingTimeBase: 55, costToProcessBase: 1000, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1000000, efficiencyUpgradeCostBase: 1500000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { emerald: 15, steel_plate: 20 }, money: 2000000 }, tier: 2 },
                         ruby_polisher: { id: 'ruby_polisher', name: 'Ruby Polisher', inputs: [{id: 'ruby', amountBase: 1}], outputResourceId: 'polished_ruby', outputAmountBase: 1, processingTimeBase: 60, costToProcessBase: 2500, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 4000000, efficiencyUpgradeCostBase: 6000000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { ruby: 15, advanced_circuit: 10 }, money: 8000000 }, tier: 2 },
                        sapphire_polisher: { id: 'sapphire_polisher', name: 'Sapphire Polisher', inputs: [{id: 'sapphire', amountBase: 1}], outputResourceId: 'polished_sapphire', outputAmountBase: 1, processingTimeBase: 65, costToProcessBase: 6000, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 15000000, efficiencyUpgradeCostBase: 20000000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { sapphire: 10, steel_plate: 30 }, money: 30000000 }, tier: 2 },
                        amethyst_polisher: { id: 'amethyst_polisher', name: 'Amethyst Polisher', inputs: [{id: 'amethyst', amountBase: 1}], outputResourceId: 'polished_amethyst', outputAmountBase: 1, processingTimeBase: 70, costToProcessBase: 15000, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 50000000, efficiencyUpgradeCostBase: 70000000, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { amethyst: 10, advanced_circuit: 20 }, money: 100000000 }, tier: 2 },
                        
                        // Tier 3 Processors
                        alloy_forge: { id: 'alloy_forge', name: 'Alloy Forge', inputs: [{id: 'titanium', amountBase: 5}, {id: 'iron_ingot', amountBase: 20}, {id: 'coal', amountBase: 50}], outputResourceId: 'titanium_alloy', outputAmountBase: 1, processingTimeBase: 180, costToProcessBase: 5e5, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1e10, efficiencyUpgradeCostBase: 1.5e10, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: { resources: { titanium: 100, steel_plate: 50 }, money: 5e10 }, tier: 3 },
                        
                        // Tier 4 Processors (Exotic)
                        element_x_refinery: { id: 'element_x_refinery', name: 'Element X Refinery', inputs: [{id: 'element_x', amountBase: 1}, {id: 'orichalcum', amountBase: 5}, {id: 'mythril', amountBase: 10}], outputResourceId: 'refined_element_x', outputAmountBase: 1, processingTimeBase: 120, costToProcessBase: 1e7, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 5e8, efficiencyUpgradeCostBase: 7.5e8, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        quantum_assembler: { id: 'quantum_assembler', name: 'Quantum Assembler', inputs: [{id: 'refined_element_x', amountBase: 1}, {id: 'advanced_circuit', amountBase: 10}, {id: 'polished_diamond', amountBase: 5}], outputResourceId: 'quantum_entangler', outputAmountBase: 1, processingTimeBase: 300, costToProcessBase: 5e7, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 2e9, efficiencyUpgradeCostBase: 3e9, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        singularity_forge: { id: 'singularity_forge', name: 'Singularity Forge', inputs: [{id: 'quantum_entangler', amountBase: 1}, {id: 'orichalcum', amountBase: 50}, {id: 'polished_amethyst', amountBase: 10}], outputResourceId: 'singularity_core', outputAmountBase: 1, processingTimeBase: 600, costToProcessBase: 2.5e8, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1e10, efficiencyUpgradeCostBase: 1.5e10, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        centrifuge_array: { id: 'centrifuge_array', name: 'Centrifuge Array', inputs: [{id: 'uranium', amountBase: 10}, {id: 'silicon', amountBase: 25}], outputResourceId: 'enriched_uranium', outputAmountBase: 1, processingTimeBase: 360, costToProcessBase: 2.5e7, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 5e12, efficiencyUpgradeCostBase: 7.5e12, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        energy_fabricator: { id: 'energy_fabricator', name: 'Energy Fabricator', inputs: [{id: 'enriched_uranium', amountBase: 1}, {id: 'advanced_circuit', amountBase: 50}, {id: 'polished_platinum', amountBase: 10}], outputResourceId: 'power_cell', outputAmountBase: 1, processingTimeBase: 480, costToProcessBase: 1e8, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 2e13, efficiencyUpgradeCostBase: 3e13, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        quantum_lab: { id: 'quantum_lab', name: 'Quantum Lab', inputs: [{id: 'quantum_entangler', amountBase: 2}, {id: 'refined_element_x', amountBase: 5}, {id: 'power_cell', amountBase: 1}, {id: 'polished_amethyst', amountBase: 20}], outputResourceId: 'quantum_computer', outputAmountBase: 1, processingTimeBase: 1200, costToProcessBase: 5e9, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1e15, efficiencyUpgradeCostBase: 1.5e15, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        void_stabilizer: { id: 'void_stabilizer', name: 'Void Stabilizer', inputs: [{id: 'void_crystal', amountBase: 1}, {id: 'singularity_core', amountBase: 1}, {id: 'quantum_computer', amountBase: 1}], outputResourceId: 'void_manipulator', outputAmountBase: 1, processingTimeBase: 3600, costToProcessBase: 1e11, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1e18, efficiencyUpgradeCostBase: 2e18, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 4 },
                        
                        // Tier 5 Processors (Cosmic)
                        stardust_condenser: { id: 'stardust_condenser', name: 'Stardust Condenser', inputs: [{id: 'stardust', amountBase: 10}, {id: 'void_manipulator', amountBase: 1}], outputResourceId: 'cosmic_alloy', outputAmountBase: 1, processingTimeBase: 1800, costToProcessBase: 5e11, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1e19, efficiencyUpgradeCostBase: 1.5e19, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 5 },
                        nebula_extractor: { id: 'nebula_extractor', name: 'Nebula Extractor', inputs: [{id: 'nebula_gas', amountBase: 5}, {id: 'power_cell', amountBase: 10}], outputResourceId: 'quantum_foam', outputAmountBase: 1, processingTimeBase: 2400, costToProcessBase: 1e12, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 5e19, efficiencyUpgradeCostBase: 7.5e19, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 5 },
                        galactic_synthesizer: { id: 'galactic_synthesizer', name: 'Galactic Synthesizer', inputs: [{id: 'cosmic_alloy', amountBase: 1}, {id: 'quantum_foam', amountBase: 1}, {id: 'singularity_core', amountBase: 5}], outputResourceId: 'galactic_core', outputAmountBase: 1, processingTimeBase: 7200, costToProcessBase: 1e14, speedLevel: 0, efficiencyLevel: 0, speedUpgradeCostBase: 1e21, efficiencyUpgradeCostBase: 2e21, isActive: false, currentProgress: 0, unlocked: false, unlockRequirements: null, tier: 5 },
                    },
                    research: { 
                        // Standard Research
                        unlock_deep_core_drill: { id: 'unlock_deep_core_drill', name: 'Deep Core Drilling', description: 'Unlocks mining of Element X.', cost: { money: 1e10, resources: { orichalcum: 100, mythril: 200, advanced_circuit: 50 } }, researchTimeBase: 300, isResearching: false, currentProgress: 0, unlocked: false, unlocksResource: 'element_x', tier: 4 },
                        unlock_element_x_refinery: { id: 'unlock_element_x_refinery', name: 'Element X Refining', description: 'Unlocks the Element X Refinery.', cost: { money: 5e10, resources: { element_x: 5 } }, researchTimeBase: 180, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'element_x_refinery', requiresResearch: 'unlock_deep_core_drill', tier: 4 },
                        unlock_quantum_assembler: { id: 'unlock_quantum_assembler', name: 'Quantum Entanglement', description: 'Unlocks the Quantum Assembler.', cost: { money: 2.5e11, resources: { refined_element_x: 5, advanced_circuit: 100 } }, researchTimeBase: 450, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'quantum_assembler', requiresResearch: 'unlock_element_x_refinery', tier: 4 },
                        unlock_singularity_forge: { id: 'unlock_singularity_forge', name: 'Singularity Forging', description: 'Unlocks the Singularity Forge.', cost: { money: 1e12, resources: { quantum_entangler: 5, orichalcum: 250 } }, researchTimeBase: 900, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'singularity_forge', requiresResearch: 'unlock_quantum_assembler', tier: 4 },
                        unlock_nuclear_extraction: { id: 'unlock_nuclear_extraction', name: 'Nuclear Extraction', description: 'Enables mining of Uranium.', cost: { money: 1e13, resources: { refined_element_x: 20, titanium_alloy: 10 } }, researchTimeBase: 600, isResearching: false, currentProgress: 0, unlocked: false, unlocksResource: 'uranium', requiresResearch: 'unlock_element_x_refinery', tier: 4 }, 
                        unlock_centrifuge_array: { id: 'unlock_centrifuge_array', name: 'Uranium Enrichment', description: 'Unlocks the Centrifuge Array for Enriched Uranium.', cost: { money: 5e13, resources: { uranium: 50, titanium_alloy: 25 } }, researchTimeBase: 720, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'centrifuge_array', requiresResearch: 'unlock_nuclear_extraction', tier: 4 },
                        unlock_energy_fabricator: { id: 'unlock_energy_fabricator', name: 'Advanced Power Cells', description: 'Unlocks the Energy Fabricator for Power Cells.', cost: { money: 2e14, resources: { enriched_uranium: 10, advanced_circuit: 200 } }, researchTimeBase: 900, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'energy_fabricator', requiresResearch: 'unlock_centrifuge_array', tier: 4 },
                        unlock_quantum_computing: { id: 'unlock_quantum_computing', name: 'Quantum Computing', description: 'Unlocks the Quantum Lab to build Quantum Computers.', cost: { money: 1e15, resources: { quantum_entangler: 20, power_cell: 5 } }, researchTimeBase: 1500, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'quantum_lab', requiresResearch: 'unlock_energy_fabricator', tier: 4 },
                        unlock_void_harnessing: { id: 'unlock_void_harnessing', name: 'Void Harnessing', description: 'Allows extraction of Void Crystals and unlocks the Void Stabilizer.', cost: { money: 5e16, resources: { singularity_core: 10, quantum_computer: 2 } }, researchTimeBase: 3600, isResearching: false, currentProgress: 0, unlocked: false, unlocksResource: 'void_crystal', unlocksProcessor: 'void_stabilizer', requiresResearch: 'unlock_quantum_computing', tier: 4 },
                        
                        // Cosmic Research (Tier 5)
                        unlock_stardust_collection: { id: 'unlock_stardust_collection', name: 'Stardust Collection Tech', description: 'Unlocks mining of Stardust Clusters.', cost: { money: 1e19, resources: { void_manipulator: 5, quantum_computer: 10 } }, researchTimeBase: 5000, isResearching: false, currentProgress: 0, unlocked: false, unlocksResource: 'stardust', requiresResearch: 'unlock_void_harnessing', tier: 5 },
                        unlock_stardust_condenser: { id: 'unlock_stardust_condenser', name: 'Stardust Condensing', description: 'Unlocks the Stardust Condenser for Cosmic Alloys.', cost: { money: 5e19, resources: { stardust: 20, void_manipulator: 2 } }, researchTimeBase: 2500, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'stardust_condenser', requiresResearch: 'unlock_stardust_collection', tier: 5 },
                        unlock_nebula_extraction: { id: 'unlock_nebula_extraction', name: 'Nebula Gas Extraction', description: 'Unlocks extraction of Nebula Gas.', cost: { money: 1e21, resources: { cosmic_alloy: 5, power_cell: 50 } }, researchTimeBase: 6000, isResearching: false, currentProgress: 0, unlocked: false, unlocksResource: 'nebula_gas', requiresResearch: 'unlock_stardust_condenser', tier: 5 },
                        unlock_nebula_processor: { id: 'unlock_nebula_processor', name: 'Quantum Foam Creation', description: 'Unlocks the Nebula Extractor for Quantum Foam.', cost: { money: 5e21, resources: { nebula_gas: 10, cosmic_alloy: 2 } }, researchTimeBase: 3000, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'nebula_extractor', requiresResearch: 'unlock_nebula_extraction', tier: 5 },
                        unlock_galactic_synthesis: { id: 'unlock_galactic_synthesis', name: 'Galactic Core Synthesis', description: 'Unlocks the Galactic Synthesizer.', cost: { money: 1e23, resources: { quantum_foam: 5, singularity_core: 20 } }, researchTimeBase: 10000, isResearching: false, currentProgress: 0, unlocked: false, unlocksProcessor: 'galactic_synthesizer', requiresResearch: 'unlock_nebula_processor', tier: 5 },
                    },
                    prestige: { 
                        points: 0,
                        totalPointsEverEarned: 0,
                        prestigesDone: 0,
                        upgrades: JSON.parse(JSON.stringify(this.getPrestigeUpgradeDefinitions())), 
                        lastPrestigeAt: null,
                        minMoneyForPrestige: 1e12 
                    },
                    stats: { 
                        totalSoldViaMarketValue: 0,
                        individualMarketSalesCount: 0,
                        totalMoneyFromPreviousPrestiges: 0,
                        totalManualClicks: 0,
                        totalResourcesMined: {}, 
                        totalItemsProcessed: {}, 
                        currentRunMoneyEarned: 0,
                        highestMoneyThisPrestige: 0,
                        allTimeHighestMoney: 0,
                        totalTimePlayedSeconds: 0,
                        sessionStartTime: Date.now(), 
                        dailyLogin: {
                            lastLoginTimestamp: null, 
                        }
                    },
                    lastUpdate: Date.now(),
                    lastSave: null,
                    currentTab: 'mines', 
                };
                Object.keys(baseState.resources).forEach(resId => {
                    if (baseState.resources[resId].manualMineBaseAmount) { 
                        baseState.stats.totalResourcesMined[resId] = 0;
                    } else if (baseState.resources[resId].value > 0 && !baseState.resources[resId].manualMineBaseAmount) { 
                         baseState.stats.totalItemsProcessed[resId] = 0;
                    }
                });

                Object.keys(this.achievementsList).forEach(achId => {
                    baseState.achievements[achId] = { unlocked: false, unlockedAt: null };
                });
                Object.keys(this.investableAssets).forEach(assetId => {
                    baseState.investments.market[assetId] = { 
                        currentPrice: this.investableAssets[assetId].basePrice, 
                        lastPrice: this.investableAssets[assetId].basePrice,
                        trendArrow: '&#8212;' 
                    };
                    baseState.investments.portfolio[assetId] = { shares: 0, avgBuyPrice: 0 };
                });
                return JSON.parse(JSON.stringify(baseState)); 
            },
            
            resetState(isPrestigeReset = false) {
                const achievementsToKeep = isPrestigeReset ? JSON.parse(JSON.stringify(this.state.achievements)) : {};
                
                const currentRunMoney = this.state.money;
                this.state.stats.totalMoneyFromPreviousPrestiges += currentRunMoney;
                this.state.stats.allTimeHighestMoney = Math.max(this.state.stats.allTimeHighestMoney, this.state.stats.highestMoneyThisPrestige, currentRunMoney);


                const statsToKeep = isPrestigeReset ? {
                    ...this.state.stats, 
                    currentRunMoneyEarned: 0, 
                    highestMoneyThisPrestige: 0, 
                } : { 
                    totalSoldViaMarketValue: 0, individualMarketSalesCount: 0, totalMoneyFromPreviousPrestiges: 0,
                    totalManualClicks: 0, totalResourcesMined: {}, totalItemsProcessed: {},
                    currentRunMoneyEarned: 0, highestMoneyThisPrestige: 0, allTimeHighestMoney: this.state.stats.allTimeHighestMoney, 
                    totalTimePlayedSeconds: this.state.stats.totalTimePlayedSeconds, 
                    sessionStartTime: Date.now(),
                    dailyLogin: { lastLoginTimestamp: this.state.stats.dailyLogin.lastLoginTimestamp } 
                };
                if (!isPrestigeReset) {
                    const defaultRes = this.getDefaultState().resources;
                     Object.keys(defaultRes).forEach(resId => {
                        if (defaultRes[resId].manualMineBaseAmount) statsToKeep.totalResourcesMined[resId] = 0;
                        else if (defaultRes[resId].value > 0 && !defaultRes[resId].manualMineBaseAmount) statsToKeep.totalItemsProcessed[resId] = 0;
                    });
                }


                let prestigeDataToKeep;
                if (isPrestigeReset) {
                    prestigeDataToKeep = JSON.parse(JSON.stringify(this.state.prestige));
                    const ppGained = this.calculatePrestigePointsToGain();
                    prestigeDataToKeep.points += ppGained;
                    prestigeDataToKeep.totalPointsEverEarned += ppGained;
                    prestigeDataToKeep.prestigesDone++;
                    prestigeDataToKeep.lastPrestigeAt = Date.now();
                } else {
                     prestigeDataToKeep = { 
                        points: 0, totalPointsEverEarned: 0, prestigesDone: 0,
                        upgrades: JSON.parse(JSON.stringify(this.getPrestigeUpgradeDefinitions())),
                        lastPrestigeAt: null, minMoneyForPrestige: 1e12
                    };
                }
                
                this.state = this.getDefaultState(); 

                this.state.achievements = achievementsToKeep;
                Object.keys(this.achievementsList).forEach(achId => { 
                    if (!this.state.achievements[achId]) {
                        this.state.achievements[achId] = { unlocked: false, unlockedAt: null };
                    }
                });

                this.state.stats = { ...this.state.stats, ...statsToKeep };
                this.state.prestige = prestigeDataToKeep;

                if (isPrestigeReset) {
                    const startingMinerBonus = this.state.prestige.upgrades.startingMiners.level * this.state.prestige.upgrades.startingMiners.effectPerLevel;
                    if (this.state.resources.stone) {
                        this.state.resources.stone.miners += startingMinerBonus;
                    }
                }

                this.state.lastUpdate = Date.now();
                this.state.stats.sessionStartTime = Date.now(); 
                console.log(isPrestigeReset ? "Game state reset for Prestige." : "Game state hard reset to default.");

                if (db && userId && isAuthReady) {
                    this.saveGame(true); 
                }
                this.render(); 
            },

            calculateOfflineProgression(lastKnownUpdateTime) {
                if (!this.state || !this.state.resources || !lastKnownUpdateTime) return;
                const now = Date.now();
                const offlineTimeSeconds = Math.max(0, (now - lastKnownUpdateTime) / 1000);

                if (offlineTimeSeconds < 10) { 
                    this.state.lastUpdate = now;
                    return;
                }

                let offlineSummary = "Welcome back! While you were away:<br><br>"; 
                let anyProduction = false;
                let minedResourcesSummary = "";
                let processedItemsSummary = "";
                let researchProgressSummary = "";

                for (const resKey in this.state.resources) {
                    const resource = this.state.resources[resKey];
                    if (resource.unlocked && resource.miners > 0 && resource.minerProductionBase) {
                        const productionPerSecond = resource.miners * this.getMinerProduction(resource);
                        const offlineGain = productionPerSecond * offlineTimeSeconds;
                        if (offlineGain > 0) {
                            resource.count += offlineGain;
                            this.state.stats.totalResourcesMined[resKey] = (this.state.stats.totalResourcesMined[resKey] || 0) + offlineGain;
                            minedResourcesSummary += `&bull; +${this.formatNumber(offlineGain)} ${resource.name}<br>`;
                            anyProduction = true;
                        }
                    }
                }
                if (minedResourcesSummary) offlineSummary += "<strong>Mined:</strong><br>" + minedResourcesSummary + "<br>";


                for (const procId in this.state.processors) {
                    const processor = this.state.processors[procId];
                    if (processor.unlocked && processor.isActive) { 
                        const actualProcessingTime = this.getActualProcessingTime(processor);
                        const batchesPossible = Math.floor(offlineTimeSeconds / actualProcessingTime);
                        const actualInputAmounts = this.getActualInputAmounts(processor); 
                        const actualOutputAmount = processor.outputAmountBase;

                        let batchesCompleted = 0;
                        for (let i = 0; i < batchesPossible; i++) {
                            let canProcessBatch = true;
                            for (const input of actualInputAmounts) {
                                if (this.state.resources[input.id].count < input.amount) {
                                    canProcessBatch = false;
                                    break;
                                }
                            }
                            if (canProcessBatch) {
                                for (const input of actualInputAmounts) {
                                    this.state.resources[input.id].count -= input.amount;
                                }
                                this.state.resources[processor.outputResourceId].count += actualOutputAmount;
                                this.state.stats.totalItemsProcessed[processor.outputResourceId] = (this.state.stats.totalItemsProcessed[processor.outputResourceId] || 0) + actualOutputAmount;
                                if (!this.state.resources[processor.outputResourceId].unlocked) {
                                    this.state.resources[processor.outputResourceId].unlocked = true;
                                }
                                batchesCompleted++;
                            } else {
                                break; 
                            }
                        }
                        if (batchesCompleted > 0) {
                             processedItemsSummary += `&bull; +${this.formatNumber(batchesCompleted * actualOutputAmount)} ${this.state.resources[processor.outputResourceId].name} (via ${processor.name})<br>`;
                             anyProduction = true;
                        }
                        processor.isActive = false; 
                        processor.currentProgress = 0;
                    }
                }
                 if (processedItemsSummary) offlineSummary += "<strong>Processed:</strong><br>" + processedItemsSummary + "<br>";

                for (const researchId in this.state.research) {
                    const researchItem = this.state.research[researchId];
                    if (researchItem.isResearching && !researchItem.unlocked) {
                        const actualResearchTime = this.getActualResearchTime(researchItem);
                        const remainingTime = actualResearchTime - researchItem.currentProgress;
                        const offlineResearchProgress = Math.min(remainingTime, offlineTimeSeconds);
                        researchItem.currentProgress += offlineResearchProgress;
                        
                        if (researchItem.currentProgress >= actualResearchTime) {
                            researchItem.unlocked = true;
                            researchItem.isResearching = false;
                            researchItem.currentProgress = actualResearchTime; 
                            researchProgressSummary += `&bull; ${researchItem.name} completed!<br>`;
                            anyProduction = true; 
                            this.handleResearchCompletion(researchId);
                        } else if (offlineResearchProgress > 0) {
                             researchProgressSummary += `&bull; ${researchItem.name} progressed by ${this.formatNumber(offlineResearchProgress, 0)}s.<br>`;
                             anyProduction = true;
                        }
                    }
                }
                if (researchProgressSummary) offlineSummary += "<strong>Research:</strong><br>" + researchProgressSummary;
                
                this.state.lastUpdate = now; 

                if (anyProduction) {
                    this.showToast(offlineSummary, 'info', 15000); 
                    console.log("Offline progression calculated:", offlineSummary.replace(/<br>/g, '\n').replace(/&bull;/g, '-').replace(/<strong>/g, '').replace(/<\/strong>/g, ''));
                } else {
                    console.log("No significant offline progression to calculate.");
                }
            },


            async loadGame() { 
                if (!db || !userId) {
                    this.resetState(false); 
                    this.calculateOfflineProgression(Date.now());
                    this.checkDailyLogin();
                    this.render();
                    const lm = document.getElementById('loading-message'); if (lm) lm.classList.add('hidden');
                    return;
                }
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/mineTycoonSF/gameState`); // Updated path
                if (gameSaveUnsubscribe) gameSaveUnsubscribe(); 
                
                try {
                    gameSaveUnsubscribe = onSnapshot(docRef, async (docSnap) => {
                        const defaultState = this.getDefaultState(); 
                        let lastKnownUpdateTime = Date.now(); 

                        if (docSnap.exists()) {
                            const loadedData = docSnap.data();
                            this.applyLoadedState(loadedData, defaultState); 
                            lastKnownUpdateTime = this.state.lastUpdate || defaultState.lastUpdate; 
                            console.log("Game loaded and merged from Firestore:", JSON.parse(JSON.stringify(this.state)));
                        } else {
                            console.log("No saved game found. Starting new game.");
                            this.resetState(false); 
                            await this.saveGame(true); 
                            lastKnownUpdateTime = this.state.lastUpdate; 
                        }
                        
                        this.calculateOfflineProgression(lastKnownUpdateTime);
                        this.checkDailyLogin(); 
                        this.checkAllAchievements(false); 
                        this.render();
                        const lm = document.getElementById('loading-message'); if (lm) lm.classList.add('hidden');
                    }, (error) => {
                        console.error("Error listening to game state:", error);
                        this.resetState(false); 
                        this.calculateOfflineProgression(Date.now()); 
                        this.checkDailyLogin();
                        this.render();
                        const lm = document.getElementById('loading-message'); if (lm) lm.classList.add('hidden');
                    });
                } catch (error) {
                    console.error("Error setting up onSnapshot listener:", error);
                    this.resetState(false); 
                    this.calculateOfflineProgression(Date.now()); 
                    this.checkDailyLogin();
                    this.render();
                    const lm = document.getElementById('loading-message'); if (lm) lm.classList.add('hidden');
                }
            },

            applyLoadedState(loadedData, defaultState) {
                this.state = { ...defaultState }; 

                for (const key in defaultState) {
                    if (loadedData.hasOwnProperty(key) && typeof loadedData[key] !== 'object' && 
                        key !== 'achievements' && key !== 'investments' && 
                        key !== 'resources' && key !== 'globalUpgrades' &&
                        key !== 'processors' && key !== 'research' && 
                        key !== 'stats' && key !== 'prestige' ) { 
                        this.state[key] = loadedData[key];
                    }
                }
                this.state.money = loadedData.money !== undefined ? loadedData.money : defaultState.money;

                this.state.resources = {}; 
                for (const resKey in defaultState.resources) {
                    this.state.resources[resKey] = { 
                        ...defaultState.resources[resKey], 
                        ...(loadedData.resources ? loadedData.resources[resKey] : {}) 
                    };
                }
                
                this.state.globalUpgrades = {};
                for (const upgKey in defaultState.globalUpgrades) {
                    this.state.globalUpgrades[upgKey] = { 
                        ...defaultState.globalUpgrades[upgKey], 
                        ...(loadedData.globalUpgrades ? loadedData.globalUpgrades[upgKey] : {}) 
                    };
                }
                
                this.state.achievements = {}; 
                Object.keys(this.achievementsList).forEach(achId => { 
                    this.state.achievements[achId] = { 
                        ...(defaultState.achievements[achId] || { unlocked: false, unlockedAt: null }), 
                        ...(loadedData.achievements ? loadedData.achievements[achId] : {}) 
                    };
                });

                this.state.investments = { ...defaultState.investments }; 
                if (loadedData.investments) {
                    this.state.investments.totalBoughtValue = loadedData.investments.totalBoughtValue || 0;
                    this.state.investments.totalSoldValue = loadedData.investments.totalSoldValue || 0;
                    this.state.investments.transactionFee = loadedData.investments.transactionFee || defaultState.investments.transactionFee;
                    
                    Object.keys(this.investableAssets).forEach(assetId => {
                        this.state.investments.market[assetId] = { 
                            ...(defaultState.investments.market[assetId] || {}), 
                            ...(loadedData.investments.market ? loadedData.investments.market[assetId] : {}) 
                        };
                        this.state.investments.portfolio[assetId] = { 
                            ...(defaultState.investments.portfolio[assetId] || { shares: 0, avgBuyPrice: 0 }), 
                            ...(loadedData.investments.portfolio ? loadedData.investments.portfolio[assetId] : {}) 
                        };
                    });
                }
                this.state.processors = {};
                for (const procKey in defaultState.processors) {
                    this.state.processors[procKey] = {
                        ...defaultState.processors[procKey],
                        ...(loadedData.processors ? loadedData.processors[procKey] : {})
                    };
                    this.state.processors[procKey].isActive = this.state.processors[procKey].isActive || false;
                    this.state.processors[procKey].currentProgress = this.state.processors[procKey].currentProgress || 0;
                }
                this.state.research = {};
                for (const researchKey in defaultState.research) {
                    this.state.research[researchKey] = {
                        ...defaultState.research[researchKey],
                        ...(loadedData.research ? loadedData.research[researchKey] : {})
                    };
                    this.state.research[researchKey].isResearching = this.state.research[researchKey].isResearching || false;
                    this.state.research[researchKey].currentProgress = this.state.research[researchKey].currentProgress || 0;
                }
                
                this.state.stats = { ...defaultState.stats }; 
                if (loadedData.stats) {
                    for (const statKey in defaultState.stats) {
                        if (loadedData.stats.hasOwnProperty(statKey)) {
                            if (typeof defaultState.stats[statKey] === 'object' && defaultState.stats[statKey] !== null && !Array.isArray(defaultState.stats[statKey])) {
                                this.state.stats[statKey] = { ...defaultState.stats[statKey], ...(loadedData.stats[statKey] || {}) };
                            } else {
                                this.state.stats[statKey] = loadedData.stats[statKey];
                            }
                        }
                    }
                    if (!this.state.stats.totalResourcesMined) this.state.stats.totalResourcesMined = {};
                    if (!this.state.stats.totalItemsProcessed) this.state.stats.totalItemsProcessed = {};
                    if (!this.state.stats.dailyLogin) this.state.stats.dailyLogin = { ...defaultState.stats.dailyLogin };
                }


                this.state.prestige = { ...defaultState.prestige };
                if (loadedData.prestige) {
                    this.state.prestige.points = loadedData.prestige.points || 0;
                    this.state.prestige.totalPointsEverEarned = loadedData.prestige.totalPointsEverEarned || 0;
                    this.state.prestige.prestigesDone = loadedData.prestige.prestigesDone || 0;
                    this.state.prestige.lastPrestigeAt = loadedData.prestige.lastPrestigeAt || null;
                    this.state.prestige.minMoneyForPrestige = loadedData.prestige.minMoneyForPrestige || defaultState.prestige.minMoneyForPrestige;
                    this.state.prestige.upgrades = {};
                    for (const pUpgKey in defaultState.prestige.upgrades) { 
                        this.state.prestige.upgrades[pUpgKey] = {
                            ...defaultState.prestige.upgrades[pUpgKey],
                            ...(loadedData.prestige.upgrades ? loadedData.prestige.upgrades[pUpgKey] : {})
                        };
                    }
                }
                this.state.lastUpdate = loadedData.lastUpdate || defaultState.lastUpdate;
                this.state.lastSave = loadedData.lastSave || null;
                this.state.currentTab = loadedData.currentTab || defaultState.currentTab;
            },


            async saveGame(showToastOnSuccess = false) { 
                if (!db || !userId || !isAuthReady) {
                    console.log("Save conditions not met (no DB or user, or auth not ready). Skipping save.");
                    return;
                }
                this.state.lastUpdate = Date.now(); 
                this.state.lastSave = Date.now(); 
                try {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/mineTycoonSF/gameState`); // Updated path
                    const stateToSave = JSON.parse(JSON.stringify(this.state)); 
                    await setDoc(docRef, stateToSave, { merge: true }); 
                    console.log("Game saved to Firestore.");
                    if(showToastOnSuccess) this.showToast("Game Saved!", 'success'); 
                } catch (error) {
                    console.error("Error saving game:", error);
                    if(showToastOnSuccess) this.showToast("Error saving game!", 'error');
                }
            },
            
            autoSaveGame() {
                if (userId && isAuthReady) { 
                    this.saveGame(false); 
                }
            },

            startMarketUpdates() {
                if (marketUpdateInterval) clearInterval(marketUpdateInterval);
                const updateFrequency = () => (Math.random() * 100 + 50) * 1000; // Slightly more frequent updates
                
                const updateMarket = () => {
                    if (!this.state || !this.state.investments) return; 
                    Object.keys(this.investableAssets).forEach(assetId => {
                        const assetDef = this.investableAssets[assetId];
                        const marketData = this.state.investments.market[assetId];
                        if (!marketData) return; 
                        
                        marketData.lastPrice = marketData.currentPrice;
                        
                        const randomChange = (Math.random() - 0.5) * 2 * assetDef.volatility; 
                        let newPrice = marketData.currentPrice * (1 + randomChange + assetDef.trend);
                        newPrice = Math.max(newPrice, assetDef.basePrice * 0.05); // Lower floor
                        newPrice = Math.min(newPrice, assetDef.basePrice * 20); // Higher ceiling
                        marketData.currentPrice = Math.round(newPrice * 100) / 100; 

                        if (marketData.currentPrice > marketData.lastPrice) marketData.trendArrow = '<span class="text-green-400">&#9650;</span>'; 
                        else if (marketData.currentPrice < marketData.lastPrice) marketData.trendArrow = '<span class="text-red-400">&#9660;</span>'; 
                        else marketData.trendArrow = '<span class="text-slate-400">&#8212;</span>'; 
                    });
                    if(this.state.currentTab === 'investments') this.render(); 
                    marketUpdateInterval = setTimeout(updateMarket, updateFrequency());
                };
                marketUpdateInterval = setTimeout(updateMarket, updateFrequency());
            },

            buyShares(assetId, amount) {
                amount = parseInt(amount);
                if (isNaN(amount) || amount <= 0) {
                    this.showToast("Invalid amount.", 'error');
                    return;
                }
                const marketData = this.state.investments.market[assetId];
                const portfolioData = this.state.investments.portfolio[assetId];
                if (!marketData || !portfolioData) { this.showToast("Asset data not found.", 'error'); return; }

                const cost = marketData.currentPrice * amount;
                const fee = cost * this.state.investments.transactionFee;
                const totalCost = cost + fee;

                if (this.state.money >= totalCost) {
                    this.state.money -= totalCost;
                    
                    const newTotalShares = portfolioData.shares + amount;
                    const newTotalValue = (portfolioData.avgBuyPrice * portfolioData.shares) + cost; 
                    portfolioData.avgBuyPrice = newTotalShares > 0 ? newTotalValue / newTotalShares : 0;
                    portfolioData.shares += amount;

                    this.state.investments.totalBoughtValue += cost; 

                    this.showToast(`Bought ${amount} ${this.investableAssets[assetId].name} shares for $${this.formatNumber(totalCost, 2)} (incl. $${this.formatNumber(fee,2)} fee).`, 'success');
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough money!", 'error');
                }
            },

            sellShares(assetId, amount) {
                amount = parseInt(amount);
                const portfolioData = this.state.investments.portfolio[assetId];
                if (!portfolioData) { this.showToast("Asset data not found.", 'error'); return; }

                if (isNaN(amount) || amount <= 0 || amount > portfolioData.shares) {
                    this.showToast("Invalid amount or not enough shares.", 'error');
                    return;
                }
                const marketData = this.state.investments.market[assetId];
                if (!marketData) { this.showToast("Market data not found.", 'error'); return; }

                const revenue = marketData.currentPrice * amount;
                const fee = revenue * this.state.investments.transactionFee;
                const totalRevenue = revenue - fee;

                this.state.money += totalRevenue;
                portfolioData.shares -= amount;
                if (portfolioData.shares === 0) {
                    portfolioData.avgBuyPrice = 0; 
                }
                this.state.investments.totalSoldValue += revenue; 

                this.showToast(`Sold ${amount} ${this.investableAssets[assetId].name} shares for $${this.formatNumber(totalRevenue, 2)} (after $${this.formatNumber(fee,2)} fee).`, 'success');
                this.checkAllAchievements();
                this.render();
                this.saveGame(true);
            },

            checkAllAchievements(showNotification = true) {
                if (!this.state || !this.state.achievements || !this.achievementsList) return;
                let newAchievementUnlocked = false;
                for (const achId in this.achievementsList) {
                    if (!this.achievementsList.hasOwnProperty(achId)) continue;
                    if (!this.state.achievements[achId]) { 
                         this.state.achievements[achId] = { unlocked: false, unlockedAt: null };
                    }

                    if (!this.state.achievements[achId].unlocked) { 
                        const achievement = this.achievementsList[achId];
                        try {
                            let conditionMet = false;
                            // Simplified null checks for new resources
                            const newResourceChecks = [
                                "stardust", "nebula_gas", "cosmic_alloy", "quantum_foam", "galactic_core"
                            ];
                            let skipAchievement = false;
                            newResourceChecks.forEach(resKey => {
                                if (achId.includes(resKey) && !this.state.resources[resKey]) {
                                    skipAchievement = true;
                                }
                            });
                            if(skipAchievement) {
                                conditionMet = false;
                            } else if (achId.includes("process_") || achId.includes("processor") || achId.includes("polish_") || achId.includes("jeweler") || achId.includes("polishing_expert") || achId.includes("research")) {
                                const outputResId = achievement.outputResourceId; 
                                const requiredResearch = achievement.requiresResearch;
                                if (!this.state.processors || (outputResId && !this.state.resources[outputResId]) || (requiredResearch && (!this.state.research || !this.state.research[requiredResearch]?.unlocked))) {
                                    conditionMet = false;
                                } else {
                                     conditionMet = achievement.condition();
                                }
                            } else if ( (achId.startsWith("mine_mythril") && !this.state.resources.mythril) ||
                                (achId.startsWith("mine_orichalcum") && !this.state.resources.orichalcum) ||
                                (achId.startsWith("unlock_mythril") && !this.state.resources.mythril) ||
                                (achId.startsWith("unlock_orichalcum") && !this.state.resources.orichalcum) ||
                                (achId.startsWith("mine_quartz") && !this.state.resources.quartz) ||
                                (achId.startsWith("unlock_quartz") && !this.state.resources.quartz) ||
                                (achId.startsWith("mine_element_x") && !this.state.resources.element_x) ||
                                (achId.startsWith("unlock_element_x") && !this.state.resources.element_x) ||
                                (achId.startsWith("mine_titanium") && !this.state.resources.titanium) ||
                                (achId.startsWith("unlock_titanium") && !this.state.resources.titanium) ||
                                (achId.startsWith("mine_uranium") && !this.state.resources.uranium) ||
                                (achId.startsWith("unlock_uranium") && !this.state.resources.uranium) ||
                                (achId.startsWith("mine_void_crystal") && !this.state.resources.void_crystal) ||
                                (achId.startsWith("unlock_void_crystal") && !this.state.resources.void_crystal) ||
                                (achId === "first_prestige" && !this.state.prestige) 
                                ) {
                                conditionMet = false;
                            } else {
                                conditionMet = achievement.condition();
                            }
                            
                            if (conditionMet) {
                                this.state.achievements[achId].unlocked = true;
                                this.state.achievements[achId].unlockedAt = Date.now();
                                if (showNotification) {
                                    this.showToast(`Achievement Unlocked: ${achievement.name}!`, 'achievement');
                                }
                                newAchievementUnlocked = true;
                                console.log(`Achievement unlocked: ${achievement.name}`);
                            }
                        } catch (e) {
                            console.error(`Error checking achievement ${achId}:`, e, "State:", JSON.parse(JSON.stringify(this.state)));
                        }
                    }
                }
                if (newAchievementUnlocked) {
                    this.render(); 
                    this.saveGame(false); 
                }
            },

            update() { 
                if (!isAuthReady || !this.state || !this.state.resources) return; 

                const now = Date.now();
                const deltaTime = (now - (this.state.lastUpdate || now)) / 1000; 

                for (const resKey in this.state.resources) {
                    const resource = this.state.resources[resKey];
                    if (resource.unlocked && resource.miners > 0 && resource.minerProductionBase) { 
                        const productionPerSecond = resource.miners * this.getMinerProduction(resource);
                        const producedAmount = productionPerSecond * deltaTime;
                        resource.count += producedAmount;
                        if (this.state.stats.totalResourcesMined && this.state.stats.totalResourcesMined.hasOwnProperty(resKey)) {
                            this.state.stats.totalResourcesMined[resKey] += producedAmount;
                        }
                    }
                }

                if (this.state.processors) {
                    for (const procId in this.state.processors) {
                        const processor = this.state.processors[procId];
                        if (processor.unlocked && processor.isActive) {
                            processor.currentProgress += deltaTime;
                            const actualProcessingTime = this.getActualProcessingTime(processor);
                            if (processor.currentProgress >= actualProcessingTime) {
                                const outputAmount = processor.outputAmountBase;
                                this.state.resources[processor.outputResourceId].count += outputAmount;
                                if (this.state.stats.totalItemsProcessed && this.state.stats.totalItemsProcessed.hasOwnProperty(processor.outputResourceId)) {
                                     this.state.stats.totalItemsProcessed[processor.outputResourceId] += outputAmount;
                                }
                                if (!this.state.resources[processor.outputResourceId].unlocked) {
                                    this.state.resources[processor.outputResourceId].unlocked = true;
                                    this.showToast(`${this.state.resources[processor.outputResourceId].name} now available!`, 'info');
                                }
                                this.showToast(`Processed 1 batch of ${this.state.resources[processor.outputResourceId].name}!`, 'success');
                                processor.isActive = false;
                                processor.currentProgress = 0;
                                this.checkAllAchievements(); 
                            }
                        }
                    }
                }
                if (this.state.research) {
                    for (const researchId in this.state.research) {
                        const researchItem = this.state.research[researchId];
                        if (researchItem.isResearching && !researchItem.unlocked) {
                            researchItem.currentProgress += deltaTime;
                            const actualResearchTime = this.getActualResearchTime(researchItem);
                            if (researchItem.currentProgress >= actualResearchTime) {
                                researchItem.unlocked = true;
                                researchItem.isResearching = false;
                                researchItem.currentProgress = actualResearchTime; 
                                this.showToast(`Research Complete: ${researchItem.name}!`, 'info', 5000); 
                                this.handleResearchCompletion(researchId);
                                this.checkAllAchievements();
                            }
                        }
                    }
                }
                
                if (this.state.stats.highestMoneyThisPrestige < this.state.money) {
                    this.state.stats.highestMoneyThisPrestige = this.state.money;
                }
                if (this.state.stats.allTimeHighestMoney < this.state.money) {
                    this.state.stats.allTimeHighestMoney = this.state.money;
                }


                this.state.lastUpdate = now; 
                this.checkAllAchievements(); 
                this.render(); 
            },

            manualMine(resourceId) {
                const resource = this.state.resources[resourceId];
                if (resource && resource.unlocked && resource.manualMineBaseAmount) { 
                    const minedAmount = this.getManualMineAmount(resource);
                    resource.count += minedAmount;
                    this.state.stats.totalManualClicks = (this.state.stats.totalManualClicks || 0) + 1;
                    if (this.state.stats.totalResourcesMined && this.state.stats.totalResourcesMined.hasOwnProperty(resourceId)) {
                         this.state.stats.totalResourcesMined[resourceId] += minedAmount;
                    }
                    this.checkAllAchievements(); 
                    this.render();
                }
            },

            sellAllResources() { 
                let totalEarnings = 0;
                const heavenlyBonusMultiplier = 1 + (this.state.prestige.upgrades.heavenlyBonus.level * this.state.prestige.upgrades.heavenlyBonus.effectPerLevel);
                for (const resKey in this.state.resources) {
                    const resource = this.state.resources[resKey];
                    if (resource.unlocked && resource.count > 0) {
                        const valuePerUnit = resource.value * this.state.globalUpgrades.sellMultiplier.value * heavenlyBonusMultiplier;
                        totalEarnings += resource.count * valuePerUnit;
                        resource.count = 0;
                    }
                }
                this.state.money += totalEarnings;
                this.state.stats.currentRunMoneyEarned += totalEarnings;
                this.showToast(`Sold all resources for $${this.formatNumber(totalEarnings,2)}!`, 'success');
                this.checkAllAchievements();
                this.render();
                this.saveGame(true); 
            },
            
            sellResource(resourceId, quantity) {
                const numQuantity = parseFloat(quantity); 
                if (isNaN(numQuantity) || numQuantity <= 0) {
                    this.showToast("Invalid quantity.", 'error');
                    return;
                }

                const resource = this.state.resources[resourceId];
                if (!resource || !resource.unlocked) {
                    this.showToast("Resource not available to sell.", 'error');
                    return;
                }
                if (resource.count < numQuantity) {
                    this.showToast(`Not enough ${resource.name} to sell.`, 'error');
                    return;
                }
                const heavenlyBonusMultiplier = 1 + (this.state.prestige.upgrades.heavenlyBonus.level * this.state.prestige.upgrades.heavenlyBonus.effectPerLevel);
                const valuePerUnit = resource.value * this.state.globalUpgrades.sellMultiplier.value * heavenlyBonusMultiplier;
                const earnings = numQuantity * valuePerUnit;

                resource.count -= numQuantity;
                this.state.money += earnings;
                this.state.stats.currentRunMoneyEarned += earnings;
                this.state.stats.totalSoldViaMarketValue += earnings;
                this.state.stats.individualMarketSalesCount++;


                this.showToast(`Sold ${this.formatNumber(numQuantity)} ${resource.name} for $${this.formatNumber(earnings, 2)}!`, 'success');
                this.checkAllAchievements();
                this.render();
                this.saveGame(true);
            },


            getManualMineAmount(resource) {
                if (!resource || !resource.manualMineBaseAmount) return 0;
                const geologistBoost = this.state.globalUpgrades.masterGeologist.value;
                const manualBoost = this.state.globalUpgrades.manualMiningBoost.value;
                return resource.manualMineBaseAmount * (1 + resource.manualMineLevel * 0.25) * manualBoost * geologistBoost;
            },
            getManualMineUpgradeCost(resource) {
                if (!resource || !resource.manualMineUpgradeCostBase) return Infinity;
                const efficiencyMultiplier = 1 - Math.min(this.state.globalUpgrades.efficiencyTraining.level * this.state.globalUpgrades.efficiencyTraining.increasePerLevel, 0.4); 
                return Math.floor(resource.manualMineUpgradeCostBase * Math.pow(1.25, resource.manualMineLevel) * efficiencyMultiplier);
            },
            buyManualMineUpgrade(resourceId) {
                const resource = this.state.resources[resourceId];
                if (!resource || !resource.manualMineUpgradeCostBase) { this.showToast("Cannot upgrade this item.", 'error'); return; }
                const cost = this.getManualMineUpgradeCost(resource);
                if (this.state.money >= cost) {
                    this.state.money -= cost;
                    resource.manualMineLevel++;
                    this.showToast(`${resource.name} Click Power Lvl ${resource.manualMineLevel}!`, 'success');
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough money!", 'error');
                }
            },

            getMinerCost(resource, forMinerNumber) { 
                if (!resource || !resource.minerCostBase) return Infinity;
                const efficiencyMultiplier = 1 - Math.min(this.state.globalUpgrades.efficiencyTraining.level * this.state.globalUpgrades.efficiencyTraining.increasePerLevel, 0.4);
                const logisticsMultiplier = 1 - Math.min(this.state.globalUpgrades.logisticsOptimization.level * this.state.globalUpgrades.logisticsOptimization.increasePerLevel, 0.3);
                return Math.floor(resource.minerCostBase * Math.pow(1.15, forMinerNumber) * efficiencyMultiplier * logisticsMultiplier);
            },

            buyMiner(resourceId, amountStr) {
                const resource = this.state.resources[resourceId];
                if (!resource || !resource.minerCostBase) { this.showToast("Cannot buy miners for this item.", 'error'); return; }

                let amountToBuy;
                if (amountStr === 'max') {
                    let tempMoney = this.state.money;
                    let count = 0;
                    let costForNext = this.getMinerCost(resource, resource.miners + count);
                    while (tempMoney >= costForNext) {
                        tempMoney -= costForNext;
                        count++;
                        costForNext = this.getMinerCost(resource, resource.miners + count);
                    }
                    amountToBuy = count;
                } else {
                    amountToBuy = parseInt(amountStr);
                }

                if (isNaN(amountToBuy) || amountToBuy <= 0) {
                    if (amountStr === 'max' && amountToBuy === 0) {
                         this.showToast("Cannot afford any more miners.", 'error');
                    } else {
                        this.showToast("Invalid amount.", 'error');
                    }
                    return;
                }

                let totalCost = 0;
                for (let i = 0; i < amountToBuy; i++) {
                    totalCost += this.getMinerCost(resource, resource.miners + i);
                }

                if (this.state.money >= totalCost) {
                    this.state.money -= totalCost;
                    resource.miners += amountToBuy;
                    this.showToast(`Bought ${amountToBuy} ${resource.name} Miner(s)! Total: ${resource.miners}`, 'success');
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough money!", 'error');
                }
            },


            getMinerProduction(resource) {
                if (!resource || !resource.minerProductionBase) return 0; 
                const timeWarpMultiplier = 1 + (this.state.prestige.upgrades.timeWarp.level * this.state.prestige.upgrades.timeWarp.effectPerLevel);
                return resource.minerProductionBase * (1 + resource.minerSpeedLevel * 0.15) * this.state.globalUpgrades.minerSpeedBoost.value * timeWarpMultiplier;
            },
            getMinerSpeedUpgradeCost(resource) {
                if (!resource || !resource.minerSpeedUpgradeCostBase) return Infinity;
                const efficiencyMultiplier = 1 - Math.min(this.state.globalUpgrades.efficiencyTraining.level * this.state.globalUpgrades.efficiencyTraining.increasePerLevel, 0.4);
                return Math.floor(resource.minerSpeedUpgradeCostBase * Math.pow(1.3, resource.minerSpeedLevel) * efficiencyMultiplier);
            },
            buyMinerSpeedUpgrade(resourceId) {
                const resource = this.state.resources[resourceId];
                 if (!resource || !resource.minerSpeedUpgradeCostBase) { this.showToast("Cannot upgrade miner speed for this item.", 'error'); return; }
                const cost = this.getMinerSpeedUpgradeCost(resource);
                if (this.state.money >= cost) {
                    this.state.money -= cost;
                    resource.minerSpeedLevel++;
                    this.showToast(`${resource.name} Miner Speed Lvl ${resource.minerSpeedLevel+1}!`, 'success'); 
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough money!", 'error');
                }
            },
            
            getGlobalUpgradeCost(upgradeKey) {
                const upgrade = this.state.globalUpgrades[upgradeKey];
                if (!upgrade) return Infinity;
                return Math.floor(upgrade.costBase * Math.pow(1.6 + (upgrade.increasePerLevel * 15) , upgrade.level)); 
            },
            buyGlobalUpgrade(upgradeKey) {
                const upgrade = this.state.globalUpgrades[upgradeKey];
                if (!upgrade) {
                    this.showToast("Upgrade not found!", 'error');
                    return;
                }
                const cost = this.getGlobalUpgradeCost(upgradeKey);
                if (this.state.money >= cost) {
                    this.state.money -= cost;
                    upgrade.level++;
                    if (upgradeKey === "researchAndDevelopment") {
                        upgrade.value = 1 - Math.min(upgrade.level * upgrade.increasePerLevel, 0.5); 
                    } else if (upgradeKey === "efficiencyTraining") {
                        upgrade.value = 1 - Math.min(upgrade.level * upgrade.increasePerLevel, 0.4);
                    } else if (upgradeKey === "logisticsOptimization") {
                         upgrade.value = 1 - Math.min(upgrade.level * upgrade.increasePerLevel, 0.3);
                    }
                     else {
                         upgrade.value = 1 + (upgrade.level * upgrade.increasePerLevel); 
                    }
                    this.showToast(`${upgrade.name} now Lvl ${upgrade.level}!`, 'success');
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough money!", 'error');
                }
            },

            getUnlockRequirements(item) { 
                if (!item || !item.unlockRequirements) return null;
                const req = JSON.parse(JSON.stringify(item.unlockRequirements)); 
                const researchBonusMultiplier = 1 - Math.min(this.state.globalUpgrades.researchAndDevelopment.level * this.state.globalUpgrades.researchAndDevelopment.increasePerLevel, 0.5);

                if (req.money) {
                    req.money = Math.floor(req.money * researchBonusMultiplier);
                }
                if (req.resources) {
                    for (const resKey in req.resources) {
                        if (this.state.resources[resKey]) {
                             req.resources[resKey] = Math.floor(req.resources[resKey] * researchBonusMultiplier);
                        }
                    }
                }
                return req;
            },

            checkUnlockConditions(item) { 
                if (!item) return false; 
                const actualRequirements = this.getUnlockRequirements(item);
                if (!item.unlocked && actualRequirements) {
                    let canUnlock = true;
                    if (actualRequirements.money && this.state.money < actualRequirements.money) canUnlock = false;
                    if (actualRequirements.resources) {
                        for (const resKey in actualRequirements.resources) {
                            if (!this.state.resources[resKey] || this.state.resources[resKey].count < actualRequirements.resources[resKey]) {
                                canUnlock = false;
                                break;
                            }
                        }
                    }
                    return canUnlock;
                }
                return false; 
            },

            unlockItem(itemId, itemType = 'resource') { 
                const item = itemType === 'processor' ? this.state.processors[itemId] : this.state.resources[itemId];
                if (!item) { this.showToast(`${itemType === 'processor' ? 'Processor' : 'Resource'} to unlock not found!`, 'error'); return; }

                const actualRequirements = this.getUnlockRequirements(item);

                if (item && !item.unlocked && actualRequirements && this.checkUnlockConditions(item)) { 
                    if (actualRequirements.money) this.state.money -= actualRequirements.money;
                    if (actualRequirements.resources) {
                        for (const resKey in actualRequirements.resources) {
                           if (this.state.resources[resKey]) this.state.resources[resKey].count -= actualRequirements.resources[resKey];
                        }
                    }
                    item.unlocked = true;
                    this.showToast(`${item.name} unlocked!`, 'success');
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast(`Cannot meet unlock requirements or ${itemType} already unlocked!`, 'error');
                }
            },

            getActualProcessingTime(processor) {
                if (!processor) return Infinity;
                const timeWarpMultiplier = 1 + (this.state.prestige.upgrades.timeWarp.level * this.state.prestige.upgrades.timeWarp.effectPerLevel);
                return Math.max(1, (processor.processingTimeBase * (1 - (processor.speedLevel * 0.05))) / timeWarpMultiplier); 
            },
            getActualInputAmounts(processor) { 
                if (!processor || !processor.inputs) return [];
                return processor.inputs.map(input => ({
                    id: input.id,
                    amount: Math.max(1, Math.ceil(input.amountBase * (1 - (processor.efficiencyLevel * 0.03))))
                }));
            },
            getActualCostToProcess(processor) {
                if (!processor) return Infinity;
                return Math.max(0, Math.ceil(processor.costToProcessBase * (1 - (processor.efficiencyLevel * 0.02)))); 
            },
            getProcessorUpgradeCost(processor, type) { 
                if (!processor) return Infinity;
                const level = type === 'speed' ? processor.speedLevel : processor.efficiencyLevel;
                const baseCost = type === 'speed' ? processor.speedUpgradeCostBase : processor.efficiencyUpgradeCostBase;
                return Math.floor(baseCost * Math.pow(1.4, level)); 
            },
            buyProcessorUpgrade(processorId, type) {
                const processor = this.state.processors[processorId];
                if (!processor) { this.showToast("Processor not found!", 'error'); return; }
                const cost = this.getProcessorUpgradeCost(processor, type);
                if (this.state.money >= cost) {
                    this.state.money -= cost;
                    if (type === 'speed') {
                        processor.speedLevel++;
                        this.showToast(`${processor.name} Speed Lvl ${processor.speedLevel}!`, 'success');
                    } else if (type === 'efficiency') {
                        processor.efficiencyLevel++;
                        this.showToast(`${processor.name} Efficiency Lvl ${processor.efficiencyLevel}!`, 'success');
                    }
                    this.checkAllAchievements();
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough money for upgrade!", 'error');
                }
            },
            startProcessing(processorId) {
                const processor = this.state.processors[processorId];
                if (!processor || !processor.unlocked) { this.showToast("Processor not available!", 'error'); return; }
                if (processor.isActive) { this.showToast(`${processor.name} is busy!`, 'error'); return; }

                const actualInputAmounts = this.getActualInputAmounts(processor);
                const cost = this.getActualCostToProcess(processor);
                let canAffordAllInputs = true;
                let missingResourcesMessage = "Not enough: ";

                for (const input of actualInputAmounts) {
                    if (!this.state.resources[input.id] || this.state.resources[input.id].count < input.amount) {
                        canAffordAllInputs = false;
                        missingResourcesMessage += `${input.amount} ${this.state.resources[input.id]?.name || input.id}, `;
                    }
                }
                missingResourcesMessage = missingResourcesMessage.slice(0, -2); 

                if (!canAffordAllInputs) {
                    this.showToast(missingResourcesMessage, 'error');
                    return;
                }
                if (this.state.money < cost) {
                    this.showToast(`Not enough money for ${processor.name}! (Need $${this.formatNumber(cost)})`, 'error');
                    return;
                }

                for (const input of actualInputAmounts) {
                    this.state.resources[input.id].count -= input.amount;
                }
                this.state.money -= cost;

                processor.isActive = true;
                processor.currentProgress = 0;
                this.showToast(`Started processing 1 batch in ${processor.name}.`, 'info');
                this.render();
                this.saveGame(false); 
            },
            
            getActualResearchTime(researchItem) {
                if (!researchItem) return Infinity;
                const researchGrant = this.state.prestige.upgrades.researchGrant;
                const grantReduction = Math.min(researchGrant.level * researchGrant.effectPerLevel, 0.60); 
                const acceleratedLearning = this.state.prestige.upgrades.acceleratedLearning;
                const learningReduction = Math.min(acceleratedLearning.level * acceleratedLearning.effectPerLevel, 0.30);
                return Math.max(1, researchItem.researchTimeBase * (1 - grantReduction) * (1 - learningReduction));
            },

            startResearch(researchId) {
                const researchItem = this.state.research[researchId];
                if (!researchItem || researchItem.unlocked || researchItem.isResearching) {
                    this.showToast("Cannot start this research now.", 'error');
                    return;
                }

                const activeResearch = Object.values(this.state.research).find(r => r.isResearching);
                if (activeResearch) {
                    this.showToast(`Already researching ${activeResearch.name}. Finish or cancel it first.`, 'error');
                    return;
                }
                
                if (researchItem.requiresResearch && !this.state.research[researchItem.requiresResearch]?.unlocked) {
                    this.showToast(`Requires prior research: ${this.state.research[researchItem.requiresResearch]?.name || 'Unknown'}.`, 'error');
                    return;
                }


                let canAfford = true;
                let missingCost = "Need: ";
                if (this.state.money < researchItem.cost.money) {
                    canAfford = false;
                    missingCost += `$${this.formatNumber(researchItem.cost.money)}, `;
                }
                for (const resKey in researchItem.cost.resources) {
                    if (!this.state.resources[resKey] || this.state.resources[resKey].count < researchItem.cost.resources[resKey]) {
                        canAfford = false;
                        missingCost += `${this.formatNumber(researchItem.cost.resources[resKey])} ${this.state.resources[resKey]?.name || resKey}, `;
                    }
                }
                missingCost = missingCost.slice(0, -2);

                if (!canAfford) {
                    this.showToast(missingCost, 'error');
                    return;
                }

                this.state.money -= researchItem.cost.money;
                for (const resKey in researchItem.cost.resources) {
                    this.state.resources[resKey].count -= researchItem.cost.resources[resKey];
                }

                researchItem.isResearching = true;
                researchItem.currentProgress = 0;
                this.showToast(`Started research: ${researchItem.name}!`, 'info');
                this.render();
                this.saveGame(true);
            },

            handleResearchCompletion(researchId) {
                const researchItem = this.state.research[researchId];
                if (!researchItem || !researchItem.unlocked) return;

                if (researchItem.unlocksResource && this.state.resources[researchItem.unlocksResource]) {
                    this.state.resources[researchItem.unlocksResource].unlocked = true;
                    this.showToast(`${this.state.resources[researchItem.unlocksResource].name} can now be mined/acquired!`, 'info', 5000);
                }
                if (researchItem.unlocksProcessor && this.state.processors[researchItem.unlocksProcessor]) {
                    this.state.processors[researchItem.unlocksProcessor].unlocked = true;
                     this.showToast(`${this.state.processors[researchItem.unlocksProcessor].name} is now available!`, 'info', 5000);
                }
                this.render();
            },

            // --- Prestige System ---
            calculatePrestigePointsToGain() {
                const totalMoneyEver = this.state.money + this.state.stats.totalMoneyFromPreviousPrestiges;
                if (totalMoneyEver < this.state.prestige.minMoneyForPrestige) {
                    return 0;
                }
                // Adjusted formula for slightly more generous PP gain at higher values
                const points = Math.floor(Math.pow(totalMoneyEver / 1e12, 0.55) * 1.5); 
                return Math.max(0, points);
            },

            canPrestige() {
                const totalMoneyEver = this.state.money + this.state.stats.totalMoneyFromPreviousPrestiges;
                return totalMoneyEver >= this.state.prestige.minMoneyForPrestige && this.calculatePrestigePointsToGain() > 0;
            },

            performPrestige() {
                if (!this.canPrestige()) {
                    this.showToast("Not enough progress to Prestige yet!", 'error');
                    return;
                }
                const ppGained = this.calculatePrestigePointsToGain();
                this.showModal(
                    "Confirm Prestige",
                    `Are you sure you want to Prestige? You will gain ${this.formatNumber(ppGained)} Prestige Point(s). Most of your progress will be reset, but you will keep achievements, prestige upgrades, and overall stats.`,
                    () => {
                        this.resetState(true); 
                        this.showToast(`Prestiged! Gained ${this.formatNumber(ppGained)} PP. Welcome to a new beginning!`, 'prestige', 7000);
                        this.switchTab('mines'); 
                    }
                );
            },

            getPrestigeUpgradeCost(upgradeKey) {
                const upgrade = this.state.prestige.upgrades[upgradeKey];
                if (!upgrade) return Infinity;
                return Math.floor(upgrade.costBase * Math.pow(upgrade.costMultiplier, upgrade.level));
            },

            buyPrestigeUpgrade(upgradeKey) {
                const upgrade = this.state.prestige.upgrades[upgradeKey];
                if (!upgrade) {
                    this.showToast("Prestige upgrade not found!", 'error');
                    return;
                }
                const cost = this.getPrestigeUpgradeCost(upgradeKey);
                if (this.state.prestige.points >= cost) {
                    this.state.prestige.points -= cost;
                    upgrade.level++;
                    this.showToast(`${upgrade.name} upgraded to Lvl ${upgrade.level}!`, 'success');
                    this.render();
                    this.saveGame(true);
                } else {
                    this.showToast("Not enough Prestige Points!", 'error');
                }
            },

            // --- Daily Login Rewards ---
            checkDailyLogin() {
                const now = new Date();
                const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())).getTime();
                const lastLoginTimestamp = this.state.stats.dailyLogin.lastLoginTimestamp;

                if (!lastLoginTimestamp || lastLoginTimestamp < todayUTC) {
                    const moneyReward = 10000 * (1 + this.state.prestige.prestigesDone * 0.75); // Increased base and prestige bonus
                    this.state.money += moneyReward;
                    this.state.stats.currentRunMoneyEarned += moneyReward;

                    const resourceTypes = ['stone', 'coal', 'iron', 'copper', 'quartz']; // Added quartz
                    let resourceRewardText = "";
                    for (let i = 0; i < 3; i++) { 
                        const randomResKey = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
                        const resAmount = Math.floor(Math.random() * 100 + 50) * (1 + this.state.prestige.prestigesDone * 1.5); // Increased amount and bonus
                        if (this.state.resources[randomResKey]) {
                            this.state.resources[randomResKey].count += resAmount;
                            resourceRewardText += `&bull; +${this.formatNumber(resAmount)} ${this.state.resources[randomResKey].name}<br>`;
                        }
                    }
                    
                    this.state.stats.dailyLogin.lastLoginTimestamp = todayUTC;
                    this.saveGame(false); 

                    let rewardMessage = `Welcome back, Commander! Daily Supply Drop:<br><br><strong>+ $${this.formatNumber(moneyReward, 2)} Credits</strong>`;
                    if(resourceRewardText) rewardMessage += `<br><br><strong>Bonus Materials:</strong><br>${resourceRewardText}`;
                    
                    this.showModal("Daily Supply Drop!", rewardMessage, () => { this.render(); }); 
                }
            },


            downloadSaveFile() {
                try {
                    this.state.lastUpdate = Date.now(); 
                    const saveData = JSON.stringify(this.state, null, 2); 
                    const blob = new Blob([saveData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                    const timeStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                    a.download = `MineTycoonSF_Save_${dateStr}_${timeStr}.json`; 
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showToast("Save file downloaded!", 'success');
                } catch (error) {
                    console.error("Error downloading save file:", error);
                    this.showToast("Error downloading save file.", 'error');
                }
            },

            handleLoadSaveFile(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        // More robust check for key properties
                        if (loadedData && loadedData.money !== undefined && loadedData.resources && loadedData.prestige && loadedData.globalUpgrades && loadedData.achievements && loadedData.investments && loadedData.processors && loadedData.research && loadedData.stats && loadedData.lastUpdate) {
                            
                            const defaultStateForMerging = this.getDefaultState();
                            this.applyLoadedState(loadedData, defaultStateForMerging); 

                            this.calculateOfflineProgression(this.state.lastUpdate); 
                            this.checkAllAchievements(false); 
                            this.render();
                            this.saveGame(true); 
                            this.showToast("Save file loaded successfully!", 'success');
                        } else {
                            this.showToast("Invalid save file format.", 'error');
                        }
                    } catch (error) {
                        console.error("Error parsing save file:", error);
                        this.showToast("Error loading save file. Make sure it's a valid JSON.", 'error');
                    } finally {
                        event.target.value = null; 
                    }
                };
                reader.onerror = () => {
                    this.showToast("Error reading file.", 'error');
                     event.target.value = null; 
                };
                reader.readAsText(file);
            },
            
            render() {
                if (!document.body || !document.getElementById('money-display') || !this.state || !this.state.resources || !this.state.globalUpgrades || !this.state.achievements || !this.state.investments || !this.state.processors || !this.state.stats || !this.state.research || !this.state.prestige) {
                    console.warn("Render called too early or critical elements/state missing. Deferring render.");
                    requestAnimationFrame(() => this.render());
                    return;
                }

                document.getElementById('money-display').textContent = `$${this.formatNumber(this.state.money, 2)}`;
                const heavenlyBonusMultiplier = 1 + (this.state.prestige.upgrades.heavenlyBonus.level * this.state.prestige.upgrades.heavenlyBonus.effectPerLevel);

                const resourcesContainer = document.getElementById('resources-container');
                if (resourcesContainer) {
                    resourcesContainer.innerHTML = ''; 
                    // Sort resources by tier, then by unlock status, then by name
                    Object.values(this.state.resources)
                        .filter(res => (res.manualMineBaseAmount || res.unlocked) && 
                                       (!res.unlockRequirements || res.unlocked || Object.values(this.state.research).find(r => r.unlocksResource === res.id)?.unlocked || res.unlocked)
                        )
                        .sort((a,b) => {
                            if (a.tier !== b.tier) return (a.tier || 99) - (b.tier || 99);
                            if (a.unlocked !== b.unlocked) return a.unlocked ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        })
                        .forEach(res => { 
                        if (!res) return; 
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl flex flex-col border border-slate-700 hover:border-sky-500 transition-all duration-200 resource-card'; 

                        if (!res.unlocked && res.unlockRequirements) { 
                            if (this.checkUnlockConditions(res)) { 
                                card.classList.add('border-2', 'border-green-500', 'cursor-pointer', 'hover:shadow-green-500/30', 'unlockable-card-glow'); 
                                card.innerHTML = this.createUnlockCardInnerHtml(res, 'resource');
                                card.querySelector('button[data-action="unlockItem"]')?.addEventListener('click', (e) => {
                                    e.stopPropagation(); 
                                    this.unlockItem(res.id, 'resource');
                                });
                            } else {
                                card.classList.add('opacity-70', 'bg-slate-800/50'); 
                                card.innerHTML = this.createLockedCardInnerHtml(res, 'resource');
                            }
                        } else if (res.unlocked) { 
                            let productionRate = (res.miners && res.miners > 0 && res.minerProductionBase) ? res.miners * this.getMinerProduction(res) : 0;
                            card.innerHTML = `
                                <div class="flex-grow"> 
                                    <h3 class="text-lg sm:text-xl font-semibold text-sky-400 font-orbitron">${res.name}</h3>
                                    <p class="text-xl sm:text-2xl my-1 sm:my-2 text-white font-roboto-mono">${this.formatNumber(res.count)}</p>
                                    <p class="text-xs sm:text-sm text-slate-400">Value: $${this.formatNumber(res.value * this.state.globalUpgrades.sellMultiplier.value * heavenlyBonusMultiplier, 2)}/unit</p>
                                    ${productionRate > 0 ? `<p class="text-xs sm:text-sm text-green-400">Prod: ${this.formatNumber(productionRate, 3)}/s</p>` : ''}
                                    ${!res.manualMineBaseAmount && !res.minerProductionBase ? '<p class="text-xs text-purple-400 italic">Processed Item</p>' : ''}
                                    <p class="text-xs text-slate-500 mt-1">Tier: ${res.tier || 'N/A'}</p>
                                </div>
                                ${res.manualMineBaseAmount ? ` 
                                <div class="mt-auto space-y-2 pt-3 border-t border-slate-700"> 
                                    <button data-action="manualMine" data-resource="${res.id}" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm">Mine ${this.formatNumber(this.getManualMineAmount(res),1)}</button>
                                    <div class="pt-2 border-t border-slate-600/50">
                                        <p class="text-xs sm:text-sm text-slate-300 mb-1">Click Lvl: ${res.manualMineLevel}</p>
                                        <button data-action="buyManualMineUpgrade" data-resource="${res.id}" class="w-full text-xs sm:text-sm bg-green-600 hover:bg-green-500 text-white py-1.5 px-2 rounded-md shadow interactive-button">Upgrade ($${this.formatNumber(this.getManualMineUpgradeCost(res))})</button>
                                    </div>
                                    <div class="pt-2 border-t border-slate-600/50">
                                        <p class="text-xs sm:text-sm text-slate-300 mb-1">Miners: ${res.miners} (Speed Lvl ${res.minerSpeedLevel + 1})</p>
                                        <div class="flex space-x-1 mb-1.5">
                                            <button data-action="buyMiner" data-resourceid="${res.id}" data-amount="1" class="flex-1 text-xs bg-purple-600 hover:bg-purple-500 text-white py-1 px-1 rounded-md shadow interactive-button-sm">x1</button>
                                            <button data-action="buyMiner" data-resourceid="${res.id}" data-amount="10" class="flex-1 text-xs bg-purple-600 hover:bg-purple-500 text-white py-1 px-1 rounded-md shadow interactive-button-sm">x10</button>
                                            <button data-action="buyMiner" data-resourceid="${res.id}" data-amount="100" class="flex-1 text-xs bg-purple-600 hover:bg-purple-500 text-white py-1 px-1 rounded-md shadow interactive-button-sm">x100</button>
                                            <button data-action="buyMiner" data-resourceid="${res.id}" data-amount="max" class="flex-1 text-xs bg-purple-600 hover:bg-purple-500 text-white py-1 px-1 rounded-md shadow interactive-button-sm">Max</button>
                                        </div>
                                        <p class="text-xs text-slate-500 mb-1 text-center">Cost for next: $${this.formatNumber(this.getMinerCost(res, res.miners))}</p>
                                        <button data-action="buyMinerSpeedUpgrade" data-resource="${res.id}" class="w-full text-xs sm:text-sm bg-teal-600 hover:bg-teal-500 text-white py-1.5 px-2 rounded-md shadow interactive-button">Upgrade Speed ($${this.formatNumber(this.getMinerSpeedUpgradeCost(res))})</button>
                                    </div>
                                </div>` : '' }`;
                        } else { 
                             card.innerHTML = `<h3 class="text-lg sm:text-xl font-semibold text-slate-600 font-orbitron">${res.name} (Research Required)</h3> <p class="text-xs text-slate-500 mt-1">Tier: ${res.tier || 'N/A'}</p>`;
                             card.classList.add('opacity-60', 'bg-slate-800/40');
                        }
                        resourcesContainer.appendChild(card);
                    });
                }


                const globalUpgradesContainer = document.getElementById('global-upgrades-container');
                if (globalUpgradesContainer) {
                    globalUpgradesContainer.innerHTML = '';
                    for (const upgradeKey in this.state.globalUpgrades) {
                        const upgrade = this.state.globalUpgrades[upgradeKey];
                        if (!upgrade) continue; 
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl flex flex-col justify-between border border-slate-700 hover:border-purple-500 transition-all duration-200 upgrade-card'; 
                        let effectDesc = upgrade.description || ""; 
                        let currentEffect = "";
                        if (upgradeKey === "sellMultiplier" || upgradeKey === "minerSpeedBoost" || upgradeKey === "manualMiningBoost" || upgradeKey === "masterGeologist") {
                             currentEffect = `${( (1 + upgrade.level * upgrade.increasePerLevel) * 100 - 100).toFixed(1)}% Bonus`; 
                        } else if (upgradeKey === "researchAndDevelopment") {
                            currentEffect = `${Math.min(upgrade.level * upgrade.increasePerLevel * 100, 50).toFixed(1)}% Cost Reduction`;
                        } else if (upgradeKey === "efficiencyTraining") {
                            currentEffect = `${Math.min(upgrade.level * upgrade.increasePerLevel * 100, 40).toFixed(1)}% Cost Reduction`;
                        } else if (upgradeKey === "logisticsOptimization") {
                             currentEffect = `${Math.min(upgrade.level * upgrade.increasePerLevel * 100, 30).toFixed(1)}% Miner Cost Reduction`;
                        }
                        card.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="text-md sm:text-lg font-semibold text-purple-400 font-orbitron">${upgrade.name}</h3>
                                <p class="text-xs sm:text-sm text-slate-400 my-1">${effectDesc}</p>
                                <p class="text-sm sm:text-base my-1 text-sky-300 font-roboto-mono">Current: ${currentEffect}</p>
                                <p class="text-xs sm:text-sm text-slate-500 mb-2">Level: ${upgrade.level}</p>
                            </div>
                            <button data-action="buyGlobalUpgrade" data-upgradekey="${upgradeKey}" class="mt-auto w-full bg-orange-600 hover:bg-orange-500 text-white font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm">Upgrade ($${this.formatNumber(this.getGlobalUpgradeCost(upgradeKey))})</button>`;
                        globalUpgradesContainer.appendChild(card);
                    }
                }
                
                const processorsContainer = document.getElementById('processors-container');
                if (processorsContainer) {
                    processorsContainer.innerHTML = '';
                     Object.values(this.state.processors)
                        .sort((a,b) => {
                            if (a.tier !== b.tier) return (a.tier || 99) - (b.tier || 99);
                            if (a.unlocked !== b.unlocked) return a.unlocked ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        })
                        .forEach(processor => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl flex flex-col border border-slate-700 hover:border-teal-500 transition-all duration-200 processor-card';

                        if (!processor.unlocked) {
                            let researchPrerequisiteMet = true;
                            let researchPrerequisiteText = "";
                            if (processor.unlockRequirements === null) { 
                                const researchLink = Object.values(this.state.research).find(r => r.unlocksProcessor === processor.id);
                                if (researchLink && !researchLink.unlocked) {
                                    researchPrerequisiteMet = false;
                                    researchPrerequisiteText = `<p class="text-xs text-red-400 mt-1">Requires Research: ${researchLink.name}</p>`;
                                } else if (!researchLink) { 
                                     researchPrerequisiteMet = false;
                                     researchPrerequisiteText = `<p class="text-xs text-red-400 mt-1">Error: Linked research not found.</p>`;
                                }
                            }

                            if (researchPrerequisiteMet && this.checkUnlockConditions(processor)) {
                                card.classList.add('border-2', 'border-green-500', 'cursor-pointer', 'hover:shadow-green-500/30', 'unlockable-card-glow');
                                card.innerHTML = this.createUnlockCardInnerHtml(processor, 'processor');
                                 card.querySelector('button[data-action="unlockItem"]')?.addEventListener('click', (e) => {
                                    e.stopPropagation(); 
                                    this.unlockItem(processor.id, 'processor');
                                });
                            } else {
                                card.classList.add('opacity-70', 'bg-slate-800/50');
                                card.innerHTML = this.createLockedCardInnerHtml(processor, 'processor', researchPrerequisiteText);
                            }
                        } else {
                            const actualInputAmounts = this.getActualInputAmounts(processor); 
                            const outputRes = this.state.resources[processor.outputResourceId];
                            const actualProcessingTime = this.getActualProcessingTime(processor);
                            const actualCostToProcess = this.getActualCostToProcess(processor);
                            const progressPercent = processor.isActive ? (processor.currentProgress / actualProcessingTime) * 100 : 0;

                            let inputsHtml = actualInputAmounts.map(input => {
                                const inputResDef = this.state.resources[input.id];
                                return `${this.formatNumber(input.amount)} ${inputResDef.name}`;
                            }).join(' + ');

                            card.innerHTML = `
                                <div class="flex-grow">
                                    <h3 class="text-lg sm:text-xl font-semibold text-teal-400 font-orbitron">${processor.name}</h3>
                                    <p class="text-xs sm:text-sm text-slate-400">Converts: ${inputsHtml} &rarr; ${processor.outputAmountBase} ${outputRes.name}</p>
                                    <p class="text-xs sm:text-sm text-slate-500">Time: ${this.formatNumber(actualProcessingTime, 1)}s | Cost: $${this.formatNumber(actualCostToProcess)}</p>
                                    <p class="text-xs text-slate-500 mt-1">Tier: ${processor.tier || 'N/A'}</p>
                                    
                                    ${processor.isActive ? `
                                    <div class="w-full bg-slate-700 rounded-full h-4 my-2 overflow-hidden relative animated-progress-bar">
                                        <div class="bg-sky-500 h-4 rounded-full" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <p class="text-xs text-center text-sky-300 font-roboto-mono">Processing... (${this.formatNumber(Math.max(0, actualProcessingTime - processor.currentProgress), 1)}s left)</p>
                                    ` : `
                                    <button data-action="startProcessing" data-processorid="${processor.id}" class="mt-2 w-full bg-sky-600 hover:bg-sky-500 text-white font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm ${processor.isActive ? 'opacity-50 cursor-not-allowed' : ''}" ${processor.isActive ? 'disabled' : ''}>
                                        Process Batch
                                    </button>
                                    `}
                                </div>
                                <div class="mt-auto pt-2 sm:pt-3 border-t border-slate-700 space-y-1.5">
                                    <p class="text-xs text-slate-300 mb-1">Speed Lvl: ${processor.speedLevel} | Efficiency Lvl: ${processor.efficiencyLevel}</p>
                                    <div class="flex space-x-2">
                                        <button data-action="buyProcessorUpgrade" data-processorid="${processor.id}" data-upgradetype="speed" class="flex-1 text-xs bg-green-600 hover:bg-green-500 text-white py-1.5 px-2 rounded-md shadow interactive-button-sm">Speed ($${this.formatNumber(this.getProcessorUpgradeCost(processor, 'speed'))})</button>
                                        <button data-action="buyProcessorUpgrade" data-processorid="${processor.id}" data-upgradetype="efficiency" class="flex-1 text-xs bg-indigo-600 hover:bg-indigo-500 text-white py-1.5 px-2 rounded-md shadow interactive-button-sm">Efficiency ($${this.formatNumber(this.getProcessorUpgradeCost(processor, 'efficiency'))})</button>
                                    </div>
                                </div>
                            `;
                        }
                        processorsContainer.appendChild(card);
                    });
                }

                const marketContainer = document.getElementById('market-container');
                if (marketContainer) {
                    marketContainer.innerHTML = '';
                    Object.values(this.state.resources).filter(res => res.unlocked && res.value > 0).sort((a,b) => a.name.localeCompare(b.name)).forEach(res => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl flex flex-col border border-slate-700 hover:border-yellow-500 transition-all duration-200 market-card';
                        const currentPrice = res.value * this.state.globalUpgrades.sellMultiplier.value * heavenlyBonusMultiplier;
                        card.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="text-lg sm:text-xl font-semibold text-yellow-400 font-orbitron">${res.name}</h3>
                                <p class="text-sm text-slate-300 font-roboto-mono">In Stock: ${this.formatNumber(res.count)}</p>
                                <p class="text-xs text-slate-400 mb-2">Sell Price: $${this.formatNumber(currentPrice, 2)}/unit</p>
                                <input type="number" id="sell-amount-${res.id}" class="bg-slate-900 border border-slate-600 text-white text-sm rounded-md p-2 w-full mb-2 focus:ring-sky-500 focus:border-sky-500 placeholder-slate-500 font-roboto-mono" placeholder="Qty to sell" min="1" max="${Math.floor(res.count)}">
                            </div>
                            <div class="mt-auto space-y-1.5 pt-2">
                                <div class="flex space-x-1">
                                    ${res.count >= 1 ? `<button data-action="sellResource" data-resourceid="${res.id}" data-sellamount="1" class="flex-1 text-xs bg-sky-700 hover:bg-sky-600 text-white py-1.5 px-2 rounded-md shadow interactive-button-sm">Sell 1</button>` : ''}
                                    ${res.count >= 10 ? `<button data-action="sellResource" data-resourceid="${res.id}" data-sellamount="10" class="flex-1 text-xs bg-sky-700 hover:bg-sky-600 text-white py-1.5 px-2 rounded-md shadow interactive-button-sm">Sell 10</button>` : ''}
                                    ${res.count >= 100 ? `<button data-action="sellResource" data-resourceid="${res.id}" data-sellamount="100" class="flex-1 text-xs bg-sky-700 hover:bg-sky-600 text-white py-1.5 px-2 rounded-md shadow interactive-button-sm">Sell 100</button>` : ''}
                                </div>
                                <button data-action="sellResourceCustom" data-resourceid="${res.id}" class="w-full bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm">Sell Custom</button>
                                <button data-action="sellResource" data-resourceid="${res.id}" data-sellamount="${res.count}" class="w-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm">Sell All (${this.formatNumber(res.count)})</button>
                            </div>
                        `;
                        marketContainer.appendChild(card);
                    });
                }

                const researchContainer = document.getElementById('research-container');
                if (researchContainer) {
                    researchContainer.innerHTML = '';
                     Object.values(this.state.research)
                        .sort((a,b) => {
                            if (a.tier !== b.tier) return (a.tier || 99) - (b.tier || 99);
                            if (a.unlocked !== b.unlocked) return a.unlocked ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        })
                        .forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl flex flex-col border border-slate-700 hover:border-indigo-500 transition-all duration-200 research-card';
                        
                        let costHtml = `Cost: $${this.formatNumber(item.cost.money)}`;
                        if (item.cost.resources) {
                            for (const resKey in item.cost.resources) {
                                costHtml += `, ${this.formatNumber(item.cost.resources[resKey])} ${this.state.resources[resKey]?.name || resKey}`;
                            }
                        }
                        
                        let prerequisiteMet = true;
                        let prerequisiteText = "";
                        if (item.requiresResearch) {
                            const prereq = this.state.research[item.requiresResearch];
                            if (!prereq || !prereq.unlocked) {
                                prerequisiteMet = false;
                                prerequisiteText = `<p class="text-xs text-red-400 mt-1">Requires: ${prereq?.name || 'Previous Research'}</p>`;
                            }
                        }
                        const actualResearchTime = this.getActualResearchTime(item);
                        let buttonHtml = '';
                        if (item.unlocked) {
                            buttonHtml = '<p class="text-center text-green-400 font-semibold mt-2 py-1.5">Research Complete!</p>';
                        } else if (item.isResearching) {
                            const progressPercent = (item.currentProgress / actualResearchTime) * 100;
                            buttonHtml = `
                                <div class="w-full bg-slate-700 rounded-full h-5 my-2 overflow-hidden relative animated-progress-bar">
                                    <div class="bg-indigo-500 h-5 rounded-full text-xs font-medium text-indigo-100 text-center p-0.5 leading-normal" style="width: ${progressPercent}%">${Math.floor(progressPercent)}%</div>
                                </div>
                                <p class="text-xs text-center text-indigo-300 font-roboto-mono">Researching... (${this.formatNumber(actualResearchTime - item.currentProgress, 0)}s left)</p>
                            `;
                        } else if (!prerequisiteMet) {
                             buttonHtml = `<button class="mt-2 w-full bg-slate-600 text-slate-400 font-medium py-2 px-4 rounded-md text-sm cursor-not-allowed" disabled>Start Research</button>`;
                        }
                        else {
                            buttonHtml = `<button data-action="startResearch" data-researchid="${item.id}" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm">Start Research</button>`;
                        }

                        card.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="text-lg sm:text-xl font-semibold text-indigo-400 font-orbitron">${item.name}</h3>
                                <p class="text-xs sm:text-sm text-slate-400 my-1">${item.description}</p>
                                <p class="text-xs sm:text-sm text-slate-500">${costHtml}</p>
                                <p class="text-xs sm:text-sm text-slate-500">Time: ${this.formatNumber(actualResearchTime,1)}s</p>
                                <p class="text-xs text-slate-500 mt-1">Tier: ${item.tier || 'N/A'}</p>
                                ${prerequisiteText}
                            </div>
                            <div class="mt-auto pt-2 sm:pt-3">
                                ${buttonHtml}
                            </div>
                        `;
                        researchContainer.appendChild(card);
                    });
                }


                const achievementsContainer = document.getElementById('achievements-container');
                if (achievementsContainer) {
                    achievementsContainer.innerHTML = '';
                    const categories = {};
                    Object.entries(this.achievementsList).forEach(([id, achDef]) => {
                        if (!achDef || !achDef.category) return; 
                        if (!categories[achDef.category]) categories[achDef.category] = [];
                        categories[achDef.category].push({id, ...achDef, outputResourceId: achDef.outputResourceId}); 
                    });

                    for (const categoryName in categories) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'mb-6 sm:mb-8'; 
                        categoryDiv.innerHTML = `<h3 class="text-xl sm:text-2xl font-semibold text-sky-300 mb-3 sm:mb-4 border-b-2 border-sky-700 pb-2 font-orbitron">${categoryName}</h3>`; 
                        const gridDiv = document.createElement('div');
                        gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4';
                        
                        categories[categoryName].sort((a,b) => { 
                            const aUnlocked = this.state.achievements[a.id]?.unlocked;
                            const bUnlocked = this.state.achievements[b.id]?.unlocked;
                            if (aUnlocked && !bUnlocked) return -1;
                            if (!aUnlocked && bUnlocked) return 1;
                            return a.name.localeCompare(b.name); 
                        }).forEach(ach => {
                            const achState = this.state.achievements[ach.id];
                            const card = document.createElement('div');
                            card.className = `p-3 sm:p-4 rounded-lg shadow-xl flex flex-col transition-all duration-300 ease-out achievement-card ${achState?.unlocked ? 'bg-green-700/80 border-2 border-green-500 transform scale-105' : 'bg-slate-800/70 backdrop-blur-sm border border-slate-700 opacity-90'}`; 
                            card.innerHTML = `
                                <div class="flex-grow">
                                    <h4 class="text-base sm:text-lg font-semibold ${achState?.unlocked ? 'text-yellow-300' : 'text-sky-400'} font-orbitron">${ach.name}</h4>
                                    <p class="text-xs sm:text-sm mt-1 ${achState?.unlocked ? 'text-green-200' : 'text-slate-400'}">${ach.description}</p>
                                </div>
                                ${achState?.unlocked && achState.unlockedAt ? `<p class="text-xs italic mt-2 pt-2 border-t ${achState?.unlocked ? 'border-green-600 text-green-300' : 'border-slate-600 text-slate-500'}">Unlocked: ${new Date(achState.unlockedAt).toLocaleDateString()}</p>` : ''}
                            `;
                            gridDiv.appendChild(card);
                        });
                        categoryDiv.appendChild(gridDiv);
                        achievementsContainer.appendChild(categoryDiv);
                    }
                }

                const investmentsContainer = document.getElementById('investments-container');
                if (investmentsContainer) {
                    investmentsContainer.innerHTML = '';
                    let totalPortfolioValue = 0;
                    for (const assetId in this.investableAssets) {
                        const assetDef = this.investableAssets[assetId];
                        const marketData = this.state.investments.market[assetId];
                        const portfolioData = this.state.investments.portfolio[assetId];
                        if (!assetDef || !marketData || !portfolioData) continue; 

                        const currentAssetValue = marketData.currentPrice * portfolioData.shares;
                        totalPortfolioValue += currentAssetValue;

                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl flex flex-col border border-slate-700 hover:border-yellow-500 transition-all duration-200 investment-card';
                        card.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="text-lg sm:text-xl font-semibold text-yellow-400 font-orbitron">${assetDef.name}</h3>
                                <p class="text-xl sm:text-2xl my-1 sm:my-2 text-white font-roboto-mono">Price: $${this.formatNumber(marketData.currentPrice, 2)} ${marketData.trendArrow || '&#8212;'}</p>
                                <p class="text-xs sm:text-sm text-slate-400">Last: $${this.formatNumber(marketData.lastPrice, 2)}</p>
                                <hr class="my-2 sm:my-3 border-slate-700">
                                <p class="text-base sm:text-lg font-medium text-sky-300 font-orbitron">Your Portfolio:</p>
                                <p class="text-xs sm:text-sm text-slate-300 font-roboto-mono">Shares: ${this.formatNumber(portfolioData.shares)}</p>
                                <p class="text-xs sm:text-sm text-slate-300 font-roboto-mono">Avg. Buy: $${this.formatNumber(portfolioData.avgBuyPrice, 2)}</p>
                                <p class="text-xs sm:text-sm text-slate-300 font-roboto-mono">Value: $${this.formatNumber(currentAssetValue, 2)}</p>
                            </div>
                            <div class="mt-auto pt-2 sm:pt-3 border-t border-slate-700 space-y-2">
                                <div class="flex space-x-2">
                                    <input type="number" id="buy-${assetId}-amount" class="bg-slate-900 border border-slate-600 text-white text-xs sm:text-sm rounded-md p-2 w-full focus:ring-sky-500 focus:border-sky-500 placeholder-slate-500 font-roboto-mono" placeholder="Qty" min="1">
                                    <button data-action="buyShares" data-assetid="${assetId}" class="bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-3 rounded-md shadow-md interactive-button text-xs sm:text-sm">Buy</button>
                                </div>
                                <div class="flex space-x-2">
                                    <input type="number" id="sell-${assetId}-amount" class="bg-slate-900 border border-slate-600 text-white text-xs sm:text-sm rounded-md p-2 w-full focus:ring-sky-500 focus:border-sky-500 placeholder-slate-500 font-roboto-mono" placeholder="Qty" min="1">
                                    <button data-action="sellShares" data-assetid="${assetId}" class="bg-red-600 hover:bg-red-500 text-white font-medium py-2 px-3 rounded-md shadow-md interactive-button text-xs sm:text-sm">Sell</button>
                                </div>
                            </div>
                        `;
                        investmentsContainer.appendChild(card);
                    }
                    const portfolioSummary = document.getElementById('portfolio-summary');
                    if (portfolioSummary) {
                         const currentTotalPortfolioValue = Object.keys(this.state.investments.portfolio).reduce((sum, assetId) => {
                            const p = this.state.investments.portfolio[assetId];
                            const m = this.state.investments.market[assetId];
                            if (p && m) {
                                return sum + (p.shares * m.currentPrice);
                            }
                            return sum;
                        }, 0);

                        const totalCostOfCurrentShares = Object.values(this.state.investments.portfolio).reduce((sum,p) => sum + (p.shares * p.avgBuyPrice), 0);
                        const unrealizedPL = currentTotalPortfolioValue - totalCostOfCurrentShares;
                        const realizedPL = (this.state.investments.totalSoldValue || 0) - (this.state.investments.totalBoughtValue || 0);


                        portfolioSummary.innerHTML = `
                            <p class="text-base sm:text-lg font-roboto-mono">Total Portfolio Value: <span class="font-semibold text-sky-400">$${this.formatNumber(totalPortfolioValue, 2)}</span></p>
                            <p class="text-xs sm:text-sm font-roboto-mono">Unrealized P/L: <span class="${unrealizedPL >= 0 ? 'text-green-400' : 'text-red-400'}">$${this.formatNumber(unrealizedPL, 2)}</span></p>
                            <p class="text-xs sm:text-sm font-roboto-mono">Realized P/L: <span class="${realizedPL >= 0 ? 'text-green-400' : 'text-red-400'}">$${this.formatNumber(realizedPL, 2)}</span></p>
                            <p class="text-xs text-slate-500 mt-1">Transaction Fee: ${this.state.investments.transactionFee * 100}% (applied on buy/sell)</p>
                        `;
                    }
                }

                const prestigeTabContent = document.getElementById('prestige-tab-content');
                if (prestigeTabContent) {
                    const prestige = this.state.prestige;
                    const totalMoneyEver = this.state.money + this.state.stats.totalMoneyFromPreviousPrestiges; 
                    const ppToGain = this.calculatePrestigePointsToGain();
                    const canPrestigeNow = this.canPrestige();
                    let prestigeInfoHtml = `
                        <p class="text-lg text-center mb-2 font-roboto-mono">Prestige Points (PP): <span class="font-bold text-yellow-300">${this.formatNumber(prestige.points)}</span></p>
                        <p class="text-sm text-center mb-1 text-slate-400 font-roboto-mono">Total PP Earned: ${this.formatNumber(prestige.totalPointsEverEarned)}</p>
                        <p class="text-sm text-center mb-4 text-slate-400 font-roboto-mono">Prestiges Done: ${this.formatNumber(prestige.prestigesDone)}</p>
                        <div class="text-center mb-6 p-4 bg-slate-800/60 rounded-lg border border-purple-700 shadow-lg">
                            <p class="text-md mb-2 text-slate-100 font-roboto-mono">On next Prestige, you will gain: <span class="font-bold text-xl ${ppToGain > 0 ? 'text-green-400' : 'text-slate-400'}">${this.formatNumber(ppToGain)} PP</span></p>
                            <button data-action="performPrestige" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg text-lg interactive-button ${!canPrestigeNow ? 'opacity-50 cursor-not-allowed' : ''}" ${!canPrestigeNow ? 'disabled' : ''}>
                                Perform Prestige
                            </button>
                            ${!canPrestigeNow && totalMoneyEver < prestige.minMoneyForPrestige ? `<p class="text-xs text-red-400 mt-1">Reach $${this.formatNumber(prestige.minMoneyForPrestige)} total earnings to unlock Prestige.</p>` : ''}
                             ${!canPrestigeNow && totalMoneyEver >= prestige.minMoneyForPrestige && ppToGain === 0 ? `<p class="text-xs text-yellow-400 mt-1">Earn more to gain Prestige Points.</p>` : ''}
                        </div>
                        <h3 class="text-xl font-semibold text-purple-400 mb-4 text-center border-t border-slate-700 pt-4 font-orbitron">Prestige Upgrades</h3>
                        <div id="prestige-upgrades-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

                    for (const upgKey in prestige.upgrades) {
                        const upgrade = prestige.upgrades[upgKey];
                        const cost = this.getPrestigeUpgradeCost(upgKey);
                        prestigeInfoHtml += `
                            <div class="bg-slate-800/70 backdrop-blur-sm p-4 rounded-lg shadow-md border border-slate-700 hover:border-purple-500 transition-colors duration-150 prestige-upgrade-card">
                                <h4 class="text-lg font-semibold text-yellow-400 font-orbitron">${upgrade.name} <span class="text-sm text-slate-400">(Lvl ${upgrade.level})</span></h4>
                                <p class="text-xs text-slate-300 my-1">${upgrade.description}</p>
                                <p class="text-sm text-sky-300 font-roboto-mono">Cost: ${this.formatNumber(cost)} PP</p>
                                <button data-action="buyPrestigeUpgrade" data-upgradekey="${upgKey}" class="mt-2 w-full bg-green-600 hover:bg-green-500 text-white font-medium py-1.5 px-3 rounded-md shadow interactive-button text-sm ${prestige.points < cost ? 'opacity-50 cursor-not-allowed' : ''}" ${prestige.points < cost ? 'disabled' : ''}>
                                    Upgrade
                                </button>
                            </div>`;
                    }
                    prestigeInfoHtml += `</div>`;
                    prestigeTabContent.innerHTML = prestigeInfoHtml;
                }

                const statsTabContent = document.getElementById('stats-tab-content');
                if (statsTabContent && this.state.stats) {
                    const stats = this.state.stats;
                    let statsHtml = `<div class="space-y-4 text-slate-300">`;

                    statsHtml += `<div class="bg-slate-800/70 backdrop-blur-sm p-4 rounded-lg shadow-xl border border-slate-700">
                        <h3 class="text-xl font-semibold text-teal-400 mb-3 border-b border-teal-700 pb-2 font-orbitron">General Stats</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-sm font-roboto-mono">
                            <p>Total Manual Clicks: <span class="font-medium text-yellow-300">${this.formatNumber(stats.totalManualClicks)}</span></p>
                            <p>Money This Prestige: <span class="font-medium text-green-400">$${this.formatNumber(stats.currentRunMoneyEarned, 2)}</span></p>
                            <p>Highest Money This Prestige: <span class="font-medium text-green-400">$${this.formatNumber(stats.highestMoneyThisPrestige, 2)}</span></p>
                            <p>All-Time Highest Money: <span class="font-medium text-amber-400">$${this.formatNumber(stats.allTimeHighestMoney, 2)}</span></p>
                            <p>Total Time Played: <span class="font-medium text-yellow-300">${this.formatTime(stats.totalTimePlayedSeconds)}</span></p>
                        </div>
                    </div>`;
                    
                    let miningStatsHtml = `<div class="bg-slate-800/70 backdrop-blur-sm p-4 rounded-lg shadow-xl border border-slate-700">
                        <h3 class="text-xl font-semibold text-teal-400 mb-3 border-b border-teal-700 pb-2 font-orbitron">Mining Totals</h3><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1 text-sm font-roboto-mono">`;
                    let hasMinedStats = false;
                    Object.keys(stats.totalResourcesMined || {}).sort((a,b) => this.state.resources[a].name.localeCompare(this.state.resources[b].name)).forEach(resId => {
                        if (this.state.resources[resId]) {
                            miningStatsHtml += `<div>${this.state.resources[resId].name}: <span class="font-medium text-yellow-300">${this.formatNumber(stats.totalResourcesMined[resId] || 0)}</span></div>`;
                            hasMinedStats = true;
                        }
                    });
                    if (!hasMinedStats) miningStatsHtml += `<p class="col-span-full text-slate-500 italic">No resources mined yet.</p>`;
                    miningStatsHtml += `</div></div>`;
                    statsHtml += miningStatsHtml;

                    let processingStatsHtml = `<div class="bg-slate-800/70 backdrop-blur-sm p-4 rounded-lg shadow-xl border border-slate-700">
                        <h3 class="text-xl font-semibold text-teal-400 mb-3 border-b border-teal-700 pb-2 font-orbitron">Processing Totals</h3><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1 text-sm font-roboto-mono">`;
                    let hasProcessedStats = false;
                    Object.keys(stats.totalItemsProcessed || {}).sort((a,b) => this.state.resources[a].name.localeCompare(this.state.resources[b].name)).forEach(resId => {
                         if (this.state.resources[resId]) { 
                            processingStatsHtml += `<div>${this.state.resources[resId].name}: <span class="font-medium text-yellow-300">${this.formatNumber(stats.totalItemsProcessed[resId] || 0)}</span></div>`;
                            hasProcessedStats = true;
                        }
                    });
                    if (!hasProcessedStats) processingStatsHtml += `<p class="col-span-full text-slate-500 italic">No items processed yet.</p>`;
                    processingStatsHtml += `</div></div>`;
                    statsHtml += processingStatsHtml;

                    statsHtml += `<div class="bg-slate-800/70 backdrop-blur-sm p-4 rounded-lg shadow-xl border border-slate-700">
                        <h3 class="text-xl font-semibold text-teal-400 mb-3 border-b border-teal-700 pb-2 font-orbitron">Prestige Stats</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-sm font-roboto-mono">
                            <p>Total PP Earned: <span class="font-medium text-purple-400">${this.formatNumber(this.state.prestige.totalPointsEverEarned)}</span></p>
                            <p>Prestiges Performed: <span class="font-medium text-purple-400">${this.formatNumber(this.state.prestige.prestigesDone)}</span></p>
                        </div>
                    </div>`;

                    statsHtml += `</div>`;
                    statsTabContent.innerHTML = statsHtml;
                }
                
                document.getElementById('mines-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'mines');
                document.getElementById('upgrades-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'upgrades');
                document.getElementById('investments-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'investments');
                document.getElementById('achievements-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'achievements');
                document.getElementById('process-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'process');
                document.getElementById('market-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'market');
                document.getElementById('research-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'research');
                document.getElementById('prestige-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'prestige');
                document.getElementById('stats-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'stats');
                document.getElementById('settings-tab-content')?.classList.toggle('hidden', this.state.currentTab !== 'settings');


                document.querySelectorAll('button[data-tab]').forEach(tabButton => {
                    const isCurrentTab = tabButton.dataset.tab === this.state.currentTab;
                    tabButton.classList.toggle('bg-sky-600', isCurrentTab); 
                    tabButton.classList.toggle('text-white', isCurrentTab);
                    tabButton.classList.toggle('shadow-inner-lg', isCurrentTab);
                    tabButton.classList.toggle('border-sky-400', isCurrentTab);
                    tabButton.classList.toggle('bg-slate-700', !isCurrentTab); 
                    tabButton.classList.toggle('text-sky-300', !isCurrentTab); 
                    tabButton.classList.toggle('hover:bg-sky-500', !isCurrentTab); 
                    tabButton.classList.toggle('border-slate-600', !isCurrentTab);
                });
            },
            
            createUnlockCardInnerHtml(item, itemType = 'resource') { 
                let requirementsText = "Requires: ";
                const actualRequirements = this.getUnlockRequirements(item);
                if (!item || !actualRequirements) return "<p>Error loading requirements.</p>"; 
                
                const reqParts = [];
                if (actualRequirements.money) reqParts.push(`$${this.formatNumber(actualRequirements.money)}`);
                if (actualRequirements.resources) {
                    reqParts.push(...Object.entries(actualRequirements.resources)
                        .map(([key, val]) => {
                            const reqResource = this.state.resources[key];
                            return `${this.formatNumber(val)} ${reqResource ? reqResource.name : key}`;
                        }));
                }
                requirementsText += reqParts.join(', ');

                return `
                    <div class="flex-grow">
                        <h3 class="text-lg sm:text-xl font-semibold text-yellow-400 font-orbitron">${item.name} (Locked)</h3>
                        <p class="text-xs sm:text-sm text-slate-300 my-1 sm:my-2">${requirementsText}</p>
                         <p class="text-xs text-slate-500 mt-1">Tier: ${item.tier || 'N/A'}</p>
                    </div>
                    <button data-action="unlockItem" data-itemid="${item.id}" data-itemtype="${itemType}" class="mt-auto w-full bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-md shadow-md interactive-button text-sm">Unlock ${item.name}</button>`;
            },

            createLockedCardInnerHtml(item, itemType = 'resource', prerequisiteText = '') { 
                let requirementsText = "Requires: ";
                const actualRequirements = this.getUnlockRequirements(item);
                
                if (!actualRequirements && prerequisiteText) {
                     requirementsText = prerequisiteText;
                } else if (!item || !actualRequirements) {
                    return "<p>Error loading requirements.</p>"; 
                } else {
                    const reqParts = [];
                    if (actualRequirements.money) reqParts.push(`$${this.formatNumber(actualRequirements.money)}`);
                    if (actualRequirements.resources) {
                         reqParts.push(...Object.entries(actualRequirements.resources)
                            .map(([key, val]) => {
                                const reqResource = this.state.resources[key];
                                return `${this.formatNumber(val)} ${reqResource ? reqResource.name : key}`;
                            }));
                    }
                     requirementsText += reqParts.join(', ');
                }


                return `
                    <div class="flex-grow">
                        <h3 class="text-lg sm:text-xl font-semibold text-slate-600 font-orbitron">${item.name} (Locked)</h3>
                        <p class="text-xs sm:text-sm text-slate-500 my-1 sm:my-2">${requirementsText}</p>
                         <p class="text-xs text-slate-500 mt-1">Tier: ${item.tier || 'N/A'}</p>
                    </div>
                    <p class="text-center text-slate-600 italic mt-auto text-xs sm:text-sm">Meet requirements to unlock.</p>`;
            },

            setupEventListeners() {
                document.body.addEventListener('click', (event) => {
                    const target = event.target.closest('button[data-action]');
                    if (!target) return;

                    const action = target.dataset.action;
                    const resourceId = target.dataset.resourceid; 
                    const upgradeKey = target.dataset.upgradekey; 
                    const assetId = target.dataset.assetid; 
                    const processorId = target.dataset.processorid;
                    const upgradeType = target.dataset.upgradetype;
                    const itemId = target.dataset.itemid;
                    const itemType = target.dataset.itemtype;
                    const sellAmount = target.dataset.sellamount;
                    const researchId = target.dataset.researchid;
                    const buyAmount = target.dataset.amount; 


                    if (action === 'manualMine') this.manualMine(target.dataset.resource); 
                    else if (action === 'buyManualMineUpgrade') this.buyManualMineUpgrade(target.dataset.resource);
                    else if (action === 'buyMiner') this.buyMiner(resourceId, buyAmount); 
                    else if (action === 'buyMinerSpeedUpgrade') this.buyMinerSpeedUpgrade(target.dataset.resource);
                    else if (action === 'sellAllResources') this.sellAllResources();
                    else if (action === 'buyGlobalUpgrade') this.buyGlobalUpgrade(upgradeKey); 
                    else if (action === 'unlockItem') this.unlockItem(itemId, itemType); 
                    else if (action === 'resetGame') this.confirmResetGame(); 
                    else if (action === 'downloadSave') this.downloadSaveFile(); 
                    else if (action === 'startResearch') this.startResearch(researchId);
                    else if (action === 'performPrestige') this.performPrestige();
                    else if (action === 'buyPrestigeUpgrade') this.buyPrestigeUpgrade(upgradeKey);
                    else if (action === 'buyShares') {
                        const amountInput = document.getElementById(`buy-${assetId}-amount`);
                        if (amountInput) {
                            this.buyShares(assetId, amountInput.value);
                            amountInput.value = ''; 
                        }
                    } else if (action === 'sellShares') {
                        const amountInput = document.getElementById(`sell-${assetId}-amount`);
                        if (amountInput) {
                            this.sellShares(assetId, amountInput.value);
                            amountInput.value = ''; 
                        }
                    } else if (action === 'startProcessing') this.startProcessing(processorId);
                    else if (action === 'buyProcessorUpgrade') this.buyProcessorUpgrade(processorId, upgradeType);
                    else if (action === 'sellResource') {
                        this.sellResource(resourceId, sellAmount);
                    } else if (action === 'sellResourceCustom') {
                        const amountInput = document.getElementById(`sell-amount-${resourceId}`);
                        if (amountInput && amountInput.value) {
                            this.sellResource(resourceId, amountInput.value);
                            amountInput.value = ''; 
                        } else {
                            this.showToast("Please enter a quantity to sell.", 'error');
                        }
                    }
                });
                 
                document.querySelectorAll('button[data-tab]').forEach(button => {
                    button.addEventListener('click', () => this.switchTab(button.dataset.tab));
                });

                const loadSaveInput = document.getElementById('load-save-input');
                if (loadSaveInput) {
                    loadSaveInput.addEventListener('change', (event) => this.handleLoadSaveFile(event));
                }
            },
            
            switchTab(tabId) {
                if(tabId && this.state.currentTab !== tabId) { 
                    this.state.currentTab = tabId;
                    this.render(); 
                }
            },

            confirmResetGame() { 
                this.showModal(
                    "Confirm Hard Reset", 
                    "Are you absolutely sure you want to reset ALL game progress? This includes money, resources, upgrades, achievements, and ALL Prestige progress. This action CANNOT be undone and will wipe your cloud save if connected.",
                    async () => { 
                        this.resetState(false); 
                        this.showToast("Game has been completely reset!", 'warning');
                    }
                );
            },
            
            formatTime(totalSeconds) {
                if (isNaN(totalSeconds) || totalSeconds < 0) return "0s";
                const days = Math.floor(totalSeconds / (3600 * 24));
                const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = Math.floor(totalSeconds % 60);

                let timeString = "";
                if (days > 0) timeString += `${days}d `;
                if (hours > 0 || days > 0) timeString += `${hours}h `; 
                if (minutes > 0 || hours > 0 || days > 0) timeString += `${minutes}m `; 
                timeString += `${seconds}s`;
                return timeString.trim() || "0s"; 
            },

            formatNumber(num, precision = 0) {
                if (num === undefined || num === null || isNaN(parseFloat(num))) return '0'; 
                const numFloat = parseFloat(num);

                if (numFloat === 0) return numFloat.toFixed(precision);
                if (Math.abs(numFloat) < 1e-9 && numFloat !== 0) return numFloat.toExponential(precision); 
                
                const tiers = [
                    { value: 1e21, symbol: "Sx" }, // Sextillion
                    { value: 1e18, symbol: "Qi" }, // Quintillion
                    { value: 1e15, symbol: "Qa" }, // Quadrillion
                    { value: 1e12, symbol: "T" },  // Trillion
                    { value: 1e9, symbol: "B" },   // Billion
                    { value: 1e6, symbol: "M" },   // Million
                    { value: 1e3, symbol: "k" }    // Thousand
                ];

                for (let i = 0; i < tiers.length; i++) {
                    if (Math.abs(numFloat) >= tiers[i].value) {
                        return (numFloat / tiers[i].value).toFixed(Math.max(precision, (tiers[i].symbol === "k" ? 1: 2) )) + tiers[i].symbol;
                    }
                }
                
                return numFloat.toLocaleString(undefined, { 
                    minimumFractionDigits: precision, 
                    maximumFractionDigits: precision 
                });
            },

            showToast(message, type = 'info', duration = 3500) { // type: 'success', 'error', 'info', 'warning', 'achievement', 'prestige'
                const toast = document.getElementById('toast-notification');
                const toastMessage = document.getElementById('toast-message');
                if(!toast || !toastMessage) { console.warn("Toast elements not found"); return; }
                
                if (toast.dataset.timeoutId) {
                    clearTimeout(parseInt(toast.dataset.timeoutId));
                }

                toastMessage.innerHTML = message; 
                toast.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'bg-sky-600', 'bg-purple-600', 'bg-yellow-500', 'border-red-500', 'border-green-500', 'border-sky-500', 'border-purple-500', 'border-yellow-400');
                toast.classList.add('border-2', 'p-4', 'text-sm'); 
                
                let baseClasses = 'text-white ';
                let borderColor = 'border-slate-500';
                let bgColor = 'bg-slate-700';

                switch(type) {
                    case 'success': bgColor = 'bg-green-600'; borderColor = 'border-green-400'; break;
                    case 'error': bgColor = 'bg-red-600'; borderColor = 'border-red-400'; break;
                    case 'info': bgColor = 'bg-sky-600'; borderColor = 'border-sky-400'; break;
                    case 'warning': bgColor = 'bg-yellow-500'; borderColor = 'border-yellow-300'; baseClasses='text-black '; break;
                    case 'achievement': bgColor = 'bg-yellow-400'; borderColor = 'border-yellow-200'; baseClasses='text-black '; break; // Special for achievements
                    case 'prestige': bgColor = 'bg-purple-600'; borderColor = 'border-purple-400'; break;
                }
                toast.className = `fixed bottom-4 right-4 sm:bottom-6 sm:right-6 p-3 sm:p-4 rounded-lg shadow-2xl transition-all duration-300 ease-in-out z-[150] text-sm max-w-sm break-words ${baseClasses} ${bgColor} ${borderColor}`;
                
                const timeoutId = setTimeout(() => { 
                    toast.classList.add('opacity-0'); // Start fade out
                    setTimeout(() => { // Wait for fade out to complete
                        toast.classList.add('hidden'); 
                        toast.classList.remove('opacity-0'); // Reset opacity for next time
                        toast.removeAttribute('data-timeout-id');
                    }, 300);
                }, duration);
                toast.dataset.timeoutId = timeoutId.toString();
            },

            showModal(title, message, onConfirm) { 
                const modal = document.getElementById('confirmation-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const confirmButton = document.getElementById('modal-confirm');
                const cancelButton = document.getElementById('modal-cancel');
                if (!modal || !modalTitle || !modalMessage || !confirmButton || !cancelButton) { console.warn("Modal elements not found"); return; }
                
                modalTitle.textContent = title;
                modalMessage.innerHTML = message; 
                
                const newConfirmButton = confirmButton.cloneNode(true);
                confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                
                const newCancelButton = cancelButton.cloneNode(true);
                cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);

                newConfirmButton.onclick = async () => { 
                    if (typeof onConfirm === 'function') { 
                        try { 
                            await onConfirm(); 
                        } catch (e) { 
                            console.error("Error in modal confirm callback:", e); 
                            this.showToast("An error occurred.", 'error');
                        } 
                    }
                    modal.classList.add('hidden');
                };
                newCancelButton.onclick = () => { 
                    modal.classList.add('hidden'); 
                };
                
                modal.classList.remove('hidden');
            }
        };

        document.addEventListener('DOMContentLoaded', () => { 
            Game.init().catch(err => {
                console.error("Error during Game.init():", err);
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.innerHTML = '<p class="text-xl sm:text-2xl text-red-500 font-orbitron">CRITICAL ERROR: Failed to load game. Please try refreshing.</p>';
                    loadingMessage.classList.remove('hidden');
                }
            });
        });
    </script>
    <style>
        body { 
            font-family: 'Roboto Mono', monospace; 
            background-color: #020617; /* Tailwind slate-950 */
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(203, 213, 225, 0.1) 1px, transparent 0), /* Subtle dot grid */
                linear-gradient(to bottom right, #020617, #0f172a, #020617); /* slate-950 to slate-900 */
            background-size: 20px 20px, auto;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace; }

        .tab-button { 
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out; 
            will-change: transform; 
            border-width: 1px;
        }
        .tab-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3); } /* sky-400 glow */
        .tab-button.bg-sky-600 { 
            box-shadow: inset 0 -2px 0 0 #0284c7, 0 1px 6px rgba(2, 132, 199, 0.4); /* Tailwind sky-600 */
        }
        
        /* Scrollbar Styling */
        .custom-scrollbar { 
            max-height: 70vh; 
            overflow-y: auto; 
            padding-right: 12px; /* Space for scrollbar */
            scrollbar-width: thin; 
            scrollbar-color: #38bdf8 #1e293b; /* thumb track - sky-400 slate-800 */
        } 
        .custom-scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; border-radius: 10px;} /* slate-900 */
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 10px; border: 2px solid #0f172a;} /* sky-400 */
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0ea5e9; } /* sky-500 */

        /* Card hover effect */
        .resource-card:hover, .upgrade-card:hover, .processor-card:hover, .market-card:hover, .research-card:hover, .investment-card:hover, .prestige-upgrade-card:hover, .achievement-card:hover {
            transform: translateY(-3px) scale(1.005);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 15px rgba(56, 189, 248, 0.2); /* sky-400 glow */
        }
        .unlockable-card-glow:hover {
             box-shadow: 0 0 20px rgba(74, 222, 128, 0.6); /* green-400 glow */
        }
        
        /* Interactive Button Style */
        .interactive-button {
            transition: all 0.15s ease-in-out;
            transform-origin: center;
        }
        .interactive-button:hover {
            transform: scale(1.03);
            filter: brightness(1.1);
        }
        .interactive-button:active {
            transform: scale(0.97);
            filter: brightness(0.9);
        }
        .interactive-button-sm { /* For smaller buttons like x1, x10 */
             transition: all 0.1s ease-in-out; transform-origin: center;
        }
        .interactive-button-sm:hover { transform: scale(1.05); filter: brightness(1.1); }
        .interactive-button-sm:active { transform: scale(0.95); filter: brightness(0.9); }

        /* Progress bar animation */
        .animated-progress-bar > div {
            transition: width 0.3s ease-in-out !important;
        }
         .animated-progress-bar > div::after {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(
                -45deg, 
                rgba(255,255,255,.08) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255,255,255,.08) 50%, 
                rgba(255,255,255,.08) 75%, 
                transparent 75%, 
                transparent
            );
            z-index: 1;
            background-size: 25px 25px;
            animation: moveProgressBar 1.5s linear infinite;
            border-radius: 9999px; /* Tailwind rounded-full */
            overflow: hidden;
        }
        @keyframes moveProgressBar {
            0% { background-position: 0 0; }
            100% { background-position: 25px 25px; }
        }
        #toast-notification {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%);
            opacity: 0;
        }
        #toast-notification:not(.hidden) {
            transform: translateX(0);
            opacity: 1;
        }
        .shadow-inner-lg {
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.25);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col items-center p-2 sm:p-4 selection:bg-sky-500 selection:text-white">

    <div id="loading-message" class="fixed inset-0 bg-slate-950 bg-opacity-95 flex flex-col items-center justify-center z-[200]">
        <svg class="animate-spin h-12 w-12 text-sky-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-xl sm:text-2xl text-sky-400 font-orbitron">Initializing Galactic Mining Systems...</p>
    </div>

    <header class="w-full max-w-7xl mb-4 sm:mb-6 text-center pt-2 sm:pt-4">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-sky-400 tracking-tight font-orbitron">Mine Tycoon: <span class="text-purple-400">Sci-Fi Overhaul</span></h1>
        <p id="money-display" class="text-2xl sm:text-3xl md:text-4xl font-semibold text-green-400 mt-1 sm:mt-2 mb-2 sm:mb-3 font-roboto-mono">$0.00</p>
        <button data-action="sellAllResources" class="bg-yellow-500 hover:bg-yellow-400 active:bg-yellow-600 text-slate-900 font-bold py-2.5 px-8 rounded-lg shadow-lg hover:shadow-yellow-500/50 transition-all duration-150 ease-in-out interactive-button text-sm sm:text-base">
            Liquidate All Assets (Quick Sell)
        </button>
    </header>

    <nav class="w-full max-w-7xl mb-6 sm:mb-8 sticky top-2 z-40 bg-slate-900/70 backdrop-blur-md py-2 shadow-2xl rounded-xl border border-slate-700">
        <div class="flex flex-col items-center bg-slate-800/50 p-1.5 sm:p-2 rounded-lg shadow-lg">
            <div class="grid grid-cols-3 gap-1 sm:gap-2 w-full mb-1 sm:mb-1.5">
                <button data-tab="mines" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Mines</button>
                <button data-tab="upgrades" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Upgrades</button>
                <button data-tab="investments" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Invest</button>
            </div>
            <div class="grid grid-cols-3 gap-1 sm:gap-2 w-full mb-1 sm:mb-1.5">
                <button data-tab="process" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Process</button>
                <button data-tab="market" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Market</button>
                <button data-tab="research" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Research</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-1 sm:gap-2 w-full">
                 <button data-tab="prestige" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Prestige</button>
                 <button data-tab="achievements" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Achieve</button>
                 <button data-tab="stats" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Stats</button>
                 <button data-tab="settings" class="tab-button py-2 px-2 sm:py-2.5 sm:px-4 rounded-md font-medium text-xs sm:text-sm">Settings</button>
            </div>
        </div>
    </nav>

    <main class="w-full max-w-7xl px-1 sm:px-2">
        <div id="mines-tab-content" class="custom-scrollbar">
            <div id="resources-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
                </div>
        </div>

        <div id="upgrades-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-purple-400 text-center font-orbitron">Global Enhancements</h2>
            <div id="global-upgrades-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-5">
                </div>
        </div>

        <div id="investments-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-yellow-400 text-center font-orbitron">Galactic Stock Exchange</h2>
            <div id="portfolio-summary" class="bg-slate-800/70 backdrop-blur-sm p-3 sm:p-4 rounded-lg shadow-xl mb-4 sm:mb-6 text-center text-xs sm:text-sm border border-slate-700">
                </div>
            <div id="investments-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-5">
                </div>
        </div>

        <div id="achievements-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 sm:mb-8 text-sky-300 text-center font-orbitron">Service Medals & Commendations</h2>
            <div id="achievements-container"> 
                </div>
        </div>

        <div id="process-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-teal-400 text-center font-orbitron">Material Fabrication Units</h2>
            <div id="processors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-5">
                </div>
        </div>

        <div id="market-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-yellow-400 text-center font-orbitron">Resource Exchange Terminal</h2>
            <div id="market-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
                </div>
        </div>

        <div id="research-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-indigo-400 text-center font-orbitron">Advanced Research Division</h2>
            <div id="research-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-5">
                </div>
        </div>

        <div id="prestige-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-purple-300 text-center font-orbitron">Temporal Reset Chamber</h2>
            </div>

        <div id="stats-tab-content" class="hidden custom-scrollbar">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-teal-300 text-center font-orbitron">Performance Metrics</h2>
            </div>
        
        <div id="settings-tab-content" class="hidden custom-scrollbar"> 
            <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6 text-sky-300 text-center font-orbitron">System Configuration</h2>
            <div class="max-w-md mx-auto bg-slate-800/70 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-xl border border-slate-700">
                <div class="mb-6">
                    <h3 class="text-lg sm:text-xl font-medium text-yellow-400 mb-2 font-orbitron">Download Save Data</h3>
                    <p class="text-xs sm:text-sm text-slate-400 mb-3">Download your current game progress as a JSON file. This can be used for backups or transferring saves.</p>
                    <button data-action="downloadSave" class="w-full bg-sky-600 hover:bg-sky-500 active:bg-sky-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md interactive-button text-sm sm:text-base">
                        Download Save
                    </button>
                </div>
                <div class="mb-6 pt-6 border-t border-slate-700">
                    <h3 class="text-lg sm:text-xl font-medium text-yellow-400 mb-2 font-orbitron">Load Save Data</h3>
                    <p class="text-xs sm:text-sm text-slate-400 mb-3">Load your game progress from a previously downloaded JSON file. This will overwrite your current game state in this browser session and attempt to sync with the cloud if logged in.</p>
                    <input type="file" id="load-save-input" accept=".json" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-600 file:text-white hover:file:bg-sky-500 cursor-pointer focus:outline-none focus:ring-2 focus:ring-sky-500"/>
                </div>
                <div class="mb-6 pt-6 border-t border-slate-700">
                    <h3 class="text-lg sm:text-xl font-medium text-yellow-400 mb-2 font-orbitron">Hard Reset Game</h3>
                    <p class="text-xs sm:text-sm text-slate-400 mb-3">Warning: This will erase all your current progress, including money, resources, upgrades, achievements, and Prestige. This action cannot be undone.</p>
                    <button data-action="resetGame" class="w-full bg-red-600 hover:bg-red-500 active:bg-red-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md interactive-button text-sm sm:text-base">
                        Reset All Progress
                    </button>
                </div>
                 <div class="mt-6 pt-4 border-t border-slate-700">
                    <p class="text-xs text-slate-500 text-center">Player ID: <span id="user-id-display-settings" class="font-roboto-mono">Loading...</span></p>
                </div>
            </div>
        </div>

    </main>

    <div id="toast-notification" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 p-3 sm:p-4 rounded-lg shadow-2xl z-[150] text-sm max-w-sm break-words border-2 hidden">
        <p id="toast-message" class="leading-relaxed font-roboto-mono"></p>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[200]">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-md w-full border border-slate-700">
            <h3 id="modal-title" class="text-xl font-semibold text-sky-300 mb-4 font-orbitron">Confirm Action</h3>
            <div id="modal-message" class="text-sm text-slate-200 mb-6 leading-relaxed font-roboto-mono">Are you sure?</div>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="bg-slate-600 hover:bg-slate-500 active:bg-slate-700 text-slate-100 font-medium py-2 px-4 rounded-md shadow interactive-button text-sm">Cancel</button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-500 active:bg-red-700 text-white font-medium py-2 px-4 rounded-md shadow interactive-button text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <footer class="w-full max-w-7xl mt-8 sm:mt-12 py-4 sm:py-6 text-center text-xs sm:text-sm text-slate-600 border-t border-slate-800">
        Mine Tycoon: Sci-Fi Overhaul &copy; 2024-2025. Galactic Operations Division.
    </footer>

</body>
</html>
